<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f8fafc">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    
    <title>Tetapan - NASZEX CLOUD</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #0f172a; --accent: #ef4444; }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #f8fafc;
            color: #1e293b; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none;
            -webkit-font-smoothing: antialiased;
        }
        
        .font-num { font-family: 'Inter', sans-serif; }
        .gpu { transform: translate3d(0,0,0); backface-visibility: hidden; perspective: 1000px; will-change: transform, opacity; }
        .glass-nav { background: rgba(255, 255, 255, 0.90); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        .glass-bottom { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-top: 1px solid rgba(226, 232, 240, 0.8); }
        .tap-effect { transition: transform 0.1s; cursor: pointer; }
        .tap-effect:active { transform: scale(0.95); }
        .nav-item-active { color: #0f172a !important; }

        .input-field { background: #f1f5f9; border: 1px solid #e2e8f0; color: #0f172a; transition: all 0.3s; width: 100%; border-radius: 1rem; padding: 0.75rem 1rem; font-size: 0.75rem; font-weight: 600; outline: none; }
        .input-field:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .input-label { font-size: 0.55rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 0.25rem; display: block; }

        /* Modal / Toast */
        .modal-overlay { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 60; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.1); }
        .modal-overlay.active .modal-content { transform: translateY(0); }

        #toast-container { position: fixed; top: calc(16px + env(safe-area-inset-top)); left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
        .toast { background: #0f172a; color: white; padding: 12px 24px; border-radius: 99px; font-size: 11px; font-weight: 700; box-shadow: 0 10px 30px rgba(0,0,0,0.15); animation: toastIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; transform: translateY(-20px); pointer-events: auto; display: flex; align-items: center; gap: 8px; }
        @keyframes toastIn { to { opacity: 1; transform: translateY(0); } }

        @supports (padding: max(0px)) {
            .safe-top { padding-top: max(0.75rem, env(safe-area-inset-top)) !important; }
            .safe-bottom { padding-bottom: max(0.5rem, env(safe-area-inset-bottom)) !important; }
        }
    </style>
</head>
<body class="min-h-screen pb-32 bg-[#f8fafc]">

    <div id="toast-container"></div>

    <nav class="sticky top-0 z-40 glass-nav px-5 py-3 gpu safe-top">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center shadow-lg shadow-slate-900/10 tap-effect">
                    <span class="text-white font-black text-[12px] italic">NX</span>
                </div>
                <div>
                    <h1 class="text-[14px] font-black uppercase text-slate-900 leading-none">Tetapan</h1>
                    <p class="text-[8px] font-bold text-slate-400 uppercase tracking-[0.2em] mt-1 leading-none">Akaun & Sistem</p>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-md mx-auto p-4 space-y-6 mt-2">
        
        <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 flex items-center gap-5 relative overflow-hidden">
            <div class="absolute -right-4 -top-4 w-24 h-24 bg-slate-50 rounded-full opacity-50"></div>
            <div class="w-16 h-16 bg-slate-900 rounded-[1.5rem] flex items-center justify-center shadow-lg shadow-slate-900/20 shrink-0 z-10">
                <i data-lucide="user" class="w-7 h-7 text-white"></i>
            </div>
            <div class="z-10">
                <h2 id="userNameDisplay" class="text-lg font-black text-slate-900 uppercase leading-tight">Memuatkan...</h2>
                <p id="userRoleDisplay" class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest mt-1 bg-emerald-50 inline-block px-2 py-0.5 rounded-md">-</p>
                <p id="userEmailDisplay" class="text-[10px] font-medium text-slate-400 mt-1 font-num hidden"></p>
            </div>
        </div>

        <div class="space-y-3">
            <div class="flex items-center justify-between px-2">
                <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Konfigurasi Syarikat</h3>
                <i data-lucide="building-2" class="w-4 h-4 text-slate-300"></i>
            </div>
            
            <div class="bg-white p-5 rounded-[1.5rem] shadow-sm border border-slate-100 space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="input-label">Nama Kedai</label>
                        <input type="text" id="bizName" class="input-field" placeholder="Cth: NASZC GSM Repair">
                    </div>
                    <div>
                        <label class="input-label">SSM Register</label>
                        <input type="text" id="bizSSM" class="input-field font-num" placeholder="Cth: 2024010...">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="input-label">No. Telefon / WA</label>
                        <input type="tel" id="bizPhone" class="input-field font-num" placeholder="012-3456789">
                    </div>
                    <div>
                        <label class="input-label">Waktu Operasi</label>
                        <input type="text" id="bizHours" class="input-field" placeholder="10AM - 10PM">
                    </div>
                </div>
                <div>
                    <label class="input-label">Alamat Penuh</label>
                    <textarea id="bizAddress" rows="2" class="input-field resize-none leading-relaxed" placeholder="Ara Kuda, Jalan Lunas..."></textarea>
                </div>
                
                <div>
                    <label class="input-label">Logo Syarikat (Untuk Resit/Invois)</label>
                    <div class="flex items-center gap-4 mt-1">
                        <div class="w-14 h-14 bg-slate-50 rounded-xl border border-slate-200 flex items-center justify-center overflow-hidden shrink-0">
                            <img id="logoPreview" src="" class="w-full h-full object-cover hidden" alt="Logo">
                            <i id="logoPlaceholder" data-lucide="image" class="w-5 h-5 text-slate-300"></i>
                        </div>
                        <div class="flex-1">
                            <input type="file" id="bizLogoFile" accept="image/*" class="hidden" onchange="uploadLogo(event)">
                            <button type="button" onclick="document.getElementById('bizLogoFile').click()" class="bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 text-[10px] font-bold px-3 py-2 rounded-lg tap-effect flex items-center gap-2 transition-colors">
                                <i data-lucide="upload-cloud" class="w-4 h-4 text-blue-500"></i> Muat Naik Gambar
                            </button>
                            <p class="text-[8px] text-slate-400 mt-1">*Format: JPG/PNG.</p>
                        </div>
                        <input type="hidden" id="bizLogoUrl" value="">
                    </div>
                </div>

                <button onclick="saveBusinessProfile()" id="btnSaveBiz" class="w-full bg-slate-900 text-white font-black uppercase text-[10px] py-3 rounded-xl flex items-center justify-center gap-2 tap-effect tracking-widest mt-2">
                    <i data-lucide="save" class="w-3.5 h-3.5"></i> Simpan Maklumat Syarikat
                </button>
            </div>
        </div>

        <div class="space-y-3">
            <div class="flex justify-between items-end px-2">
                <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Katalog Servis (Labor)</h3>
                <button onclick="openServiceModal()" class="text-[9px] font-black text-blue-500 uppercase tracking-widest flex items-center gap-1 bg-blue-50 px-2.5 py-1 rounded-md tap-effect">
                    <i data-lucide="plus" class="w-3 h-3"></i> Tambah Servis
                </button>
            </div>
            
            <div class="bg-white rounded-[1.5rem] shadow-sm border border-slate-100 overflow-hidden">
                <div id="serviceCatalogList" class="divide-y divide-slate-50 flex flex-col max-h-60 overflow-y-auto">
                    <div class="p-5 text-center text-slate-400 text-[10px] font-bold tracking-widest uppercase">
                        Memuatkan Data...
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-3">
            <div class="flex justify-between items-end px-2">
                <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Matriks Harga Alat Ganti</h3>
                <button onclick="openMatrixModal()" class="text-[9px] font-black text-emerald-500 uppercase tracking-widest flex items-center gap-1 bg-emerald-50 px-2.5 py-1 rounded-md tap-effect">
                    <i data-lucide="plus" class="w-3 h-3"></i> Tambah Matriks
                </button>
            </div>
            
            <div class="bg-white rounded-[1.5rem] shadow-sm border border-slate-100 flex flex-col overflow-hidden">
                <div class="p-3 border-b border-slate-50">
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                        <input type="text" id="searchBrand" onkeyup="filterMatrix()" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-[10px] font-bold uppercase rounded-xl py-2.5 pl-9 pr-3 outline-none focus:border-emerald-500 focus:bg-white transition-all placeholder:normal-case placeholder:font-medium" placeholder="Cari jenama...">
                    </div>
                </div>

                <div id="matrixCatalogList" class="grid grid-cols-2 gap-3 p-3 max-h-80 overflow-y-auto">
                    <div class="col-span-2 p-5 text-center text-slate-400 text-[10px] font-bold tracking-widest uppercase">
                        Memuatkan Data...
                    </div>
                </div>
            </div>
            <p class="text-[8px] font-bold text-slate-400 px-2 leading-relaxed">
                *Gunakan carian untuk akses pantas.
            </p>
        </div>

        <div class="space-y-3">
            <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-widest px-2">Sistem App</h3>
            <div class="bg-white rounded-[1.5rem] shadow-sm border border-slate-100 overflow-hidden">
                <button onclick="clearCache()" class="w-full p-4 flex items-center justify-between tap-effect border-b border-slate-50">
                    <div class="flex items-center gap-4">
                        <div class="w-9 h-9 bg-blue-50 text-blue-500 rounded-xl flex items-center justify-center"><i data-lucide="refresh-cw" class="w-4 h-4"></i></div>
                        <div class="text-left">
                            <h4 class="text-[11px] font-black text-slate-900 uppercase">Clear Cache</h4>
                            <p class="text-[8px] font-bold text-slate-400 uppercase tracking-wider mt-0.5">Segarkan data memori</p>
                        </div>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i>
                </button>
                <div class="w-full p-4 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-9 h-9 bg-slate-50 text-slate-400 rounded-xl flex items-center justify-center"><i data-lucide="info" class="w-4 h-4"></i></div>
                        <div class="text-left">
                            <h4 class="text-[11px] font-black text-slate-900 uppercase">Versi Sistem</h4>
                            <p class="text-[8px] font-bold text-slate-400 uppercase tracking-wider mt-0.5">NASZEX CLOUD v2.0 Repair Management System</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="pt-2 pb-6">
            <button onclick="logoutApp()" id="btnLogout" class="w-full bg-white border-2 border-rose-100 text-rose-500 hover:bg-rose-50 hover:border-rose-200 p-4 rounded-2xl font-black uppercase text-[11px] tracking-widest tap-effect flex items-center justify-center gap-2 transition-colors">
                <i data-lucide="log-out" class="w-4 h-4"></i> Log Keluar Akaun
            </button>
        </div>
        
    </div>

    <div class="fixed bottom-0 left-0 right-0 z-40 glass-bottom px-4 py-2 safe-bottom gpu">
        <div class="max-w-md mx-auto grid grid-cols-5 items-end h-14 pb-2">
            <button onclick="window.location.href='index.html'" class="group flex flex-col items-center justify-center gap-1.5 tap-effect text-slate-400 transition-colors">
                <i data-lucide="layout-grid" class="w-5 h-5"></i>
                <span class="text-[9px] font-black uppercase tracking-tight">Home</span>
            </button>
            <button class="group flex flex-col items-center justify-center gap-1.5 tap-effect text-slate-400 opacity-50">
                <div class="w-5 h-5 bg-slate-900 text-white rounded-md flex items-center justify-center shadow-md">
                     <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                </div>
                <span class="text-[9px] font-black uppercase tracking-tight">New</span>
            </button>
            <button class="group flex flex-col items-center justify-center gap-1.5 tap-effect text-slate-400 opacity-50">
                <i data-lucide="pie-chart" class="w-5 h-5"></i>
                <span class="text-[9px] font-black uppercase tracking-tight">Data</span>
            </button>
            <button class="group flex flex-col items-center justify-center gap-1.5 tap-effect text-slate-400 opacity-50">
                <i data-lucide="wrench" class="w-5 h-5"></i>
                <span class="text-[9px] font-black uppercase tracking-tight">Tools</span>
            </button>
            <button class="group flex flex-col items-center justify-center gap-1.5 tap-effect transition-colors nav-item-active">
                <i data-lucide="settings" class="w-5 h-5"></i>
                <span class="text-[9px] font-black uppercase tracking-tight">Setting</span>
            </button>
        </div>
    </div>

    <div id="serviceModal" class="fixed inset-0 flex items-end sm:items-center justify-center modal-overlay">
        <div class="w-full max-w-md bg-white rounded-t-[2rem] sm:rounded-[2rem] p-6 shadow-2xl modal-content max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-sm font-black text-slate-900 uppercase">Katalog Servis Baru</h3>
                <button onclick="closeServiceModal()" class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 tap-effect">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="input-label">Nama Servis (Rules)</label>
                    <input type="text" id="svcName" class="input-field" placeholder="Cth: Screen Replacement">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="input-label">Kategori</label>
                        <select id="svcCategory" class="input-field appearance-none bg-[url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2224%22%20height%3D%2224%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22none%22%20stroke%3D%22%2364748b%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpolyline%20points%3D%226%209%2012%2015%2018%209%22%3E%3C%2Fpolyline%3E%3C%2Fsvg%3E')] bg-no-repeat bg-[position:right_10px_center] bg-[length:16px]">
                            <option value="Hardware">Hardware</option>
                            <option value="Software">Software</option>
                            <option value="Diagnostic">Diagnostik / Check</option>
                        </select>
                    </div>
                    <div>
                        <label class="input-label">Caj Asas / Upah (RM)</label>
                        <input type="number" id="svcLabor" class="input-field font-num" placeholder="Cth: 50.00">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="input-label">Anggaran Masa</label>
                        <select id="svcTime" class="input-field appearance-none">
                            <option value="15-30 Minit">15-30 Minit</option>
                            <option value="1-2 Jam">1-2 Jam</option>
                            <option value="1-3 Hari">1-3 Hari</option>
                            <option value="Seminggu">Tinggal Seminggu</option>
                        </select>
                    </div>
                    <div>
                        <label class="input-label">Tempoh Waranti</label>
                        <select id="svcWarranty" class="input-field appearance-none">
                            <option value="Tiada">Tiada Waranti</option>
                            <option value="7 Hari">7 Hari</option>
                            <option value="30 Hari">30 Hari / 1 Bulan</option>
                            <option value="90 Hari">90 Hari / 3 Bulan</option>
                        </select>
                    </div>
                </div>
                
                <button onclick="saveNewService()" id="btnSaveSvc" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black uppercase text-[10px] py-3.5 rounded-xl flex items-center justify-center gap-2 tap-effect tracking-widest mt-4 shadow-lg shadow-blue-600/20">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i> Masukkan Dalam Katalog
                </button>
            </div>
        </div>
    </div>

    <div id="matrixModal" class="fixed inset-0 flex items-end sm:items-center justify-center modal-overlay z-50">
        <div class="w-full max-w-md bg-white rounded-t-[2rem] sm:rounded-[2rem] p-6 shadow-2xl modal-content max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-sm font-black text-slate-900 uppercase">Tambah Matriks Alat Ganti</h3>
                <button onclick="closeMatrixModal()" class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 tap-effect">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="input-label">Jenama (Brand)</label>
                        <input type="text" id="matBrand" class="input-field" placeholder="Cth: Apple / Samsung">
                    </div>
                    <div>
                        <label class="input-label">Model Peranti</label>
                        <input type="text" id="matModel" class="input-field font-num" placeholder="Cth: iPhone 11 Pro">
                    </div>
                </div>
                <div>
                    <label class="input-label">Jenis Part & Gred</label>
                    <input type="text" id="matGrade" class="input-field" placeholder="Cth: LCD - OLED / Bateri - Ori">
                </div>
                <div>
                    <label class="input-label">Harga Part (RM)</label>
                    <input type="number" id="matPrice" class="input-field font-num" placeholder="Cth: 250.00">
                </div>
                
                <button onclick="saveNewMatrix()" id="btnSaveMat" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-black uppercase text-[10px] py-3.5 rounded-xl flex items-center justify-center gap-2 tap-effect tracking-widest mt-4 shadow-lg shadow-emerald-600/20">
                    <i data-lucide="layers" class="w-4 h-4"></i> Simpan Matriks
                </button>
            </div>
        </div>
    </div>

    <div id="brandDetailsModal" class="fixed inset-0 flex items-end sm:items-center justify-center modal-overlay z-50">
        <div class="w-full max-w-md bg-white rounded-t-[2rem] sm:rounded-[2rem] p-6 shadow-2xl modal-content max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-5 shrink-0">
                <div>
                    <h3 id="brandDetailsTitle" class="text-sm font-black text-slate-900 uppercase">Brand</h3>
                    <p class="text-[9px] font-bold text-slate-400 mt-0.5 uppercase tracking-widest">Senarai Alat Ganti Tersimpan</p>
                </div>
                <button onclick="closeBrandDetails()" class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 tap-effect">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div id="brandDetailsList" class="overflow-y-auto space-y-2 flex-1 pb-4">
                </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

    <script>
        lucide.createIcons();

        const firebaseConfig = {
            apiKey: "AIzaSyBJdeEbuE9FlAeK4cJRaqiMkd7aa8EbwWE",
            authDomain: "rms-cloudnas.firebaseapp.com",
            databaseURL: "https://rms-cloudnas-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "rms-cloudnas",
            storageBucket: "rms-cloudnas.firebasestorage.app",
            messagingSenderId: "142738217487",
            appId: "1:142738217487:web:2c2a08c40b77447484a17a"
        };
        
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        let isGuest = false;
        let globalMatrixData = []; 

        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.replace('login.html');
            } else {
                isGuest = user.isAnonymous;
                if (isGuest) {
                    document.getElementById('userNameDisplay').innerText = "Guest User";
                    document.getElementById('userRoleDisplay').innerText = "Akaun Demo";
                    document.getElementById('userRoleDisplay').className = "text-[10px] font-bold text-amber-500 uppercase tracking-widest mt-1 bg-amber-50 inline-block px-2 py-0.5 rounded-md";
                } else {
                    document.getElementById('userNameDisplay').innerText = "Admin NASZC";
                    document.getElementById('userRoleDisplay').innerText = "Administrator";
                    document.getElementById('userEmailDisplay').innerText = user.email;
                    document.getElementById('userEmailDisplay').classList.remove('hidden');
                }
                loadBusinessProfile();
                loadServiceCatalog();
                loadPricingMatrix();
            }
        });

        // ----------------------------------------
        // FUNGSI KONFIGURASI PERNIAGAAN & LOGO
        // ----------------------------------------
        async function loadBusinessProfile() {
            try {
                const doc = await db.collection('settings').doc('business_profile').get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('bizName').value = data.name || '';
                    document.getElementById('bizSSM').value = data.ssm || '';
                    document.getElementById('bizPhone').value = data.phone || '';
                    document.getElementById('bizHours').value = data.hours || '';
                    document.getElementById('bizAddress').value = data.address || '';
                    
                    const logoUrl = data.logoUrl || '';
                    document.getElementById('bizLogoUrl').value = logoUrl;
                    
                    if(logoUrl) {
                        const preview = document.getElementById('logoPreview');
                        preview.src = logoUrl;
                        preview.classList.remove('hidden');
                        document.getElementById('logoPlaceholder').classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error("Gagal muat profil: ", error);
            }
        }

        async function uploadLogo(event) {
            if (isGuest) return showToast("Fungsi disekat dalam Mod Guest", "error");
            const file = event.target.files[0];
            if (!file) return;

            const btn = event.target.nextElementSibling;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader" class="w-4 h-4 text-blue-500 animate-spin"></i> Memuat naik...`;
            btn.disabled = true;

            try {
                const storageRef = storage.ref(`logos/business_logo_${Date.now()}`);
                const snapshot = await storageRef.put(file);
                const url = await snapshot.ref.getDownloadURL();
                
                document.getElementById('bizLogoUrl').value = url;
                const preview = document.getElementById('logoPreview');
                preview.src = url;
                preview.classList.remove('hidden');
                document.getElementById('logoPlaceholder').classList.add('hidden');
                
                showToast("Logo berjaya dimuat naik!");
            } catch (error) {
                showToast("Gagal memuat naik logo", "error");
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                lucide.createIcons();
            }
        }

        async function saveBusinessProfile() {
            if (isGuest) return showToast("Fungsi disekat dalam Mod Guest", "error");
            
            const btn = document.getElementById('btnSaveBiz');
            btn.innerHTML = `<i data-lucide="loader" class="w-3.5 h-3.5 animate-spin"></i> Menyimpan...`;
            
            const bizData = {
                name: document.getElementById('bizName').value.trim(),
                ssm: document.getElementById('bizSSM').value.trim(),
                phone: document.getElementById('bizPhone').value.trim(),
                hours: document.getElementById('bizHours').value.trim(),
                address: document.getElementById('bizAddress').value.trim(),
                logoUrl: document.getElementById('bizLogoUrl').value.trim(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('settings').doc('business_profile').set(bizData, { merge: true });
                showToast("Konfigurasi syarikat dikemaskini.");
            } catch (error) {
                showToast("Gagal menyimpan: " + error.message, "error");
            } finally {
                btn.innerHTML = `<i data-lucide="save" class="w-3.5 h-3.5"></i> Simpan Maklumat Syarikat`;
                lucide.createIcons();
            }
        }

        // ----------------------------------------
        // FUNGSI KATALOG SERVIS
        // ----------------------------------------
        function openServiceModal() { document.getElementById('serviceModal').classList.add('active'); }
        function closeServiceModal() { 
            document.getElementById('serviceModal').classList.remove('active');
            document.getElementById('svcName').value = '';
            document.getElementById('svcLabor').value = '';
        }

        async function loadServiceCatalog() {
            const listContainer = document.getElementById('serviceCatalogList');
            try {
                db.collection('settings').doc('service_catalog').collection('items')
                  .orderBy('createdAt', 'desc')
                  .onSnapshot(snapshot => {
                    listContainer.innerHTML = '';
                    if (snapshot.empty) {
                        listContainer.innerHTML = `<div class="p-5 text-center text-slate-400 text-[10px] font-bold tracking-widest uppercase">Tiada Servis Didaftarkan</div>`;
                        return;
                    }

                    snapshot.forEach(doc => {
                        const s = doc.data();
                        const color = s.category === 'Hardware' ? 'text-amber-500 bg-amber-50' : (s.category === 'Software' ? 'text-blue-500 bg-blue-50' : 'text-purple-500 bg-purple-50');
                        
                        listContainer.innerHTML += `
                            <div class="p-4 flex items-center justify-between group">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-lg flex items-center justify-center ${color}">
                                        <i data-lucide="${s.category === 'Hardware' ? 'cpu' : (s.category === 'Software' ? 'smartphone' : 'activity')}" class="w-4 h-4"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-[11px] font-black text-slate-900">${s.name}</h4>
                                        <div class="flex gap-2 mt-1">
                                            <span class="text-[8px] font-bold text-slate-400 bg-slate-50 px-1.5 py-0.5 rounded uppercase font-num">RM${parseFloat(s.laborBase).toFixed(2)}</span>
                                            <span class="text-[8px] font-bold text-slate-400 bg-slate-50 px-1.5 py-0.5 rounded uppercase">${s.estTime}</span>
                                            <span class="text-[8px] font-bold text-slate-400 bg-slate-50 px-1.5 py-0.5 rounded uppercase">${s.warranty}</span>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="deleteService('${doc.id}')" class="w-7 h-7 bg-rose-50 text-rose-500 rounded-md flex items-center justify-center tap-effect opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                                    <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                </button>
                            </div>
                        `;
                    });
                    lucide.createIcons();
                });
            } catch (error) {
                listContainer.innerHTML = `<div class="p-5 text-center text-rose-500 text-[10px] font-bold tracking-widest uppercase">Gagal memuat katalog</div>`;
            }
        }

        async function saveNewService() {
            if (isGuest) return showToast("Fungsi disekat dalam Mod Guest", "error");
            
            const name = document.getElementById('svcName').value.trim();
            const category = document.getElementById('svcCategory').value;
            const laborBase = document.getElementById('svcLabor').value.trim();
            const estTime = document.getElementById('svcTime').value;
            const warranty = document.getElementById('svcWarranty').value;

            if (!name || !laborBase) return showToast("Sila isi Nama Servis dan Caj Asas!", "error");

            const btn = document.getElementById('btnSaveSvc');
            btn.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Memproses...`;

            try {
                await db.collection('settings').doc('service_catalog').collection('items').add({
                    name: name,
                    category: category,
                    laborBase: parseFloat(laborBase),
                    estTime: estTime,
                    warranty: warranty,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast("Servis berjaya ditambah!");
                closeServiceModal();
            } catch (error) {
                showToast("Ralat menyimpan data", "error");
            } finally {
                btn.innerHTML = `<i data-lucide="plus-circle" class="w-4 h-4"></i> Masukkan Dalam Katalog`;
                lucide.createIcons();
            }
        }

        async function deleteService(id) {
            if (isGuest) return showToast("Fungsi disekat dalam Mod Guest", "error");
            if(confirm("Padam servis ini dari katalog?")) {
                try {
                    await db.collection('settings').doc('service_catalog').collection('items').doc(id).delete();
                    showToast("Servis dipadam.");
                } catch (error) {
                    showToast("Gagal memadam servis.", "error");
                }
            }
        }

        // ----------------------------------------
        // FUNGSI MATRIKS HARGA ALAT GANTI (GROUPING & SEARCH)
        // ----------------------------------------
        function openMatrixModal() { document.getElementById('matrixModal').classList.add('active'); }
        function closeMatrixModal() { 
            document.getElementById('matrixModal').classList.remove('active');
            document.getElementById('matBrand').value = '';
            document.getElementById('matModel').value = '';
            document.getElementById('matGrade').value = '';
            document.getElementById('matPrice').value = '';
        }

        async function loadPricingMatrix() {
            const listContainer = document.getElementById('matrixCatalogList');
            db.collection('settings').doc('pricing_matrix').collection('items')
              .orderBy('createdAt', 'desc')
              .onSnapshot(snapshot => {
                globalMatrixData = [];
                const brandsMap = {}; 
                
                if (snapshot.empty) {
                    listContainer.innerHTML = `<div class="col-span-2 p-5 text-center text-slate-400 text-[10px] font-bold tracking-widest uppercase">Tiada Matriks Didaftarkan</div>`;
                    return;
                }

                snapshot.forEach(doc => {
                    const m = doc.data();
                    m.id = doc.id;
                    globalMatrixData.push(m);
                    
                    const brandName = m.brand.toUpperCase();
                    if(!brandsMap[brandName]) brandsMap[brandName] = [];
                    brandsMap[brandName].push(m);
                });

                listContainer.innerHTML = '';
                
                // Jana Card untuk setiap Brand dengan atribut data-brand untuk rujukan fungsi Search
                for (let brand in brandsMap) {
                    const count = brandsMap[brand].length;
                    listContainer.innerHTML += `
                        <div data-brand="${brand}" onclick="openBrandDetails('${brand}')" class="brand-card bg-white border border-slate-200 rounded-[1.2rem] p-4 flex flex-col items-center justify-center gap-2 tap-effect shadow-sm hover:shadow-md transition-shadow">
                            <div class="w-10 h-10 bg-emerald-50 text-emerald-500 rounded-full flex items-center justify-center">
                                <i data-lucide="smartphone" class="w-5 h-5"></i>
                            </div>
                            <h4 class="text-[12px] font-black text-slate-900 text-center uppercase leading-tight mt-1">${brand}</h4>
                            <span class="text-[9px] font-bold text-slate-400 bg-slate-50 border border-slate-100 px-2.5 py-0.5 rounded-full">${count} Model Disimpan</span>
                        </div>
                    `;
                }
                lucide.createIcons();
                // Call filter in case search input already has text when reloading data
                filterMatrix(); 
            }, error => {
                listContainer.innerHTML = `<div class="col-span-2 p-5 text-center text-rose-500 text-[10px] font-bold tracking-widest uppercase">Gagal memuat matriks</div>`;
            });
        }

        // FUNGSI CARIAN JENAMA REAL-TIME
        function filterMatrix() {
            const input = document.getElementById('searchBrand').value.toUpperCase();
            const cards = document.querySelectorAll('.brand-card');
            
            cards.forEach(card => {
                const brand = card.getAttribute('data-brand').toUpperCase();
                // Guna CSS display: flex (kerana kad asal menggunakan flexbox)
                if (brand.includes(input)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function openBrandDetails(brand) {
            document.getElementById('brandDetailsTitle').innerText = brand;
            const container = document.getElementById('brandDetailsList');
            container.innerHTML = '';
            
            const items = globalMatrixData.filter(m => m.brand.toUpperCase() === brand);
            items.forEach(m => {
                container.innerHTML += `
                    <div class="bg-slate-50 border border-slate-100 rounded-[1rem] p-3 flex justify-between items-center group">
                        <div>
                            <h4 class="text-[11px] font-black text-slate-900">${m.model}</h4>
                            <div class="flex gap-2 mt-1">
                                <span class="text-[8px] font-bold text-slate-500 bg-white border border-slate-200 px-1.5 py-0.5 rounded uppercase">${m.grade}</span>
                                <span class="text-[8px] font-black text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded font-num">RM${parseFloat(m.price).toFixed(2)}</span>
                            </div>
                        </div>
                        <button onclick="deleteMatrix('${m.id}')" class="w-8 h-8 bg-white border border-rose-100 text-rose-500 rounded-lg flex items-center justify-center tap-effect shadow-sm">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
            });
            lucide.createIcons();
            document.getElementById('brandDetailsModal').classList.add('active');
        }

        function closeBrandDetails() {
            document.getElementById('brandDetailsModal').classList.remove('active');
        }

        async function saveNewMatrix() {
            if (isGuest) return showToast("Fungsi disekat dalam Mod Guest", "error");
            
            const brand = document.getElementById('matBrand').value.trim();
            const model = document.getElementById('matModel').value.trim();
            const grade = document.getElementById('matGrade').value.trim();
            const price = document.getElementById('matPrice').value.trim();

            if (!brand || !model || !grade || !price) return showToast("Sila isi semua maklumat matriks!", "error");

            const btn = document.getElementById('btnSaveMat');
            btn.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Menyimpan...`;

            try {
                await db.collection('settings').doc('pricing_matrix').collection('items').add({
                    brand: brand,
                    model: model,
                    grade: grade,
                    price: parseFloat(price),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast("Matriks harga berjaya ditambah!");
                closeMatrixModal();
            } catch (error) {
                showToast("Ralat menyimpan data matriks", "error");
            } finally {
                btn.innerHTML = `<i data-lucide="layers" class="w-4 h-4"></i> Simpan Matriks`;
                lucide.createIcons();
            }
        }

        async function deleteMatrix(id) {
            if (isGuest) return showToast("Fungsi disekat dalam Mod Guest", "error");
            if(confirm("Padam matriks harga ini? Data tidak boleh dikembalikan.")) {
                try {
                    await db.collection('settings').doc('pricing_matrix').collection('items').doc(id).delete();
                    showToast("Matriks dipadam.");
                    closeBrandDetails();
                } catch (error) {
                    showToast("Gagal memadam matriks.", "error");
                }
            }
        }

        // ----------------------------------------
        // FUNGSI LAIN-LAIN
        // ----------------------------------------
        function logoutApp() {
            const btn = document.getElementById('btnLogout');
            btn.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Memproses...`;
            auth.signOut().then(() => showToast("Log keluar berjaya.")).catch(error => {
                showToast("Ralat: " + error.message, "error");
                btn.innerHTML = `<i data-lucide="log-out" class="w-4 h-4"></i> Log Keluar Akaun`;
                lucide.createIcons();
            });
        }

        function clearCache() {
            showToast("Menyegarkan memori cache...");
            setTimeout(() => window.location.reload(true), 1000);
        }

        function showToast(msg, type='success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const icon = type === 'success' ? 'check-circle' : 'alert-circle';
            const color = type === 'success' ? 'text-emerald-400' : 'text-rose-400';
            toast.className = 'toast';
            toast.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4 ${color}"></i> <span>${msg}</span>`;
            container.appendChild(toast);
            lucide.createIcons();
            if(navigator.vibrate) navigator.vibrate(50);
            setTimeout(() => { toast.classList.add('out'); setTimeout(() => toast.remove(), 300); }, 3000);
        }
    </script>
</body>
</html>
