<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    
    <title>Setting - NASZEX CLOUD</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #0f172a; --accent: #ef4444; }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #f8fafc; color: #1e293b; 
            -webkit-tap-highlight-color: transparent; user-select: none; overscroll-behavior-y: none; -webkit-font-smoothing: antialiased;
        }
        
        .font-num { font-family: 'Inter', sans-serif; }
        .gpu { transform: translate3d(0,0,0); backface-visibility: hidden; perspective: 1000px; will-change: transform, opacity; }

        .glass-nav { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        
        .tap-effect { transition: transform 0.1s; cursor: pointer; }
        .tap-effect:active { transform: scale(0.95); }

        .input-field { background: #f8fafc; border: 1px solid #e2e8f0; color: #0f172a; transition: all 0.3s; width: 100%; border-radius: 1rem; padding: 0.85rem 1rem; font-size: 0.75rem; font-weight: 700; outline: none; }
        .input-field:focus:not(:disabled) { border-color: #3b82f6; background: #ffffff; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .input-label { font-size: 0.6rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 0.35rem; display: block; }

        #toast-container { position: fixed; top: calc(16px + env(safe-area-inset-top)); left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
        .toast { background: #0f172a; color: white; padding: 12px 24px; border-radius: 99px; font-size: 11px; font-weight: 700; box-shadow: 0 10px 30px rgba(0,0,0,0.15); animation: toastIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; transform: translateY(-20px); pointer-events: auto; display: flex; align-items: center; gap: 8px; }
        @keyframes toastIn { to { opacity: 1; transform: translateY(0); } }

        @supports (padding: max(0px)) {
            .safe-top { padding-top: max(0.75rem, env(safe-area-inset-top)) !important; }
            .safe-bottom { padding-bottom: max(0.5rem, env(safe-area-inset-bottom)) !important; }
        }
        
        .dash-card-gradient { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
    </style>
</head>
<body class="bg-[#f8fafc] overflow-x-hidden pb-12">

    <div id="toast-container"></div>

    <nav class="sticky top-0 z-40 glass-nav px-5 py-3 gpu safe-top">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center shadow-lg tap-effect">
                    <span class="text-slate-900 font-black text-[12px] italic">NX</span>
                </div>
                <div>
                    <h1 class="text-[14px] font-black italic uppercase tracking-[0.1em] text-white leading-none">Setting</h1>
                    <p class="text-[8px] font-bold text-slate-400 uppercase tracking-[0.3em] mt-1 leading-none">Account & System</p>
                </div>
            </div>
            
            <button onclick="window.location.href='index.html#dashboard'" class="w-10 h-10 flex items-center justify-center bg-slate-800 hover:bg-slate-700 rounded-xl text-white border border-slate-700 tap-effect shadow-sm transition-colors" aria-label="Kembali ke Dashboard">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
            </button>
        </div>
    </nav>

    <div class="max-w-md mx-auto p-4 space-y-5 pt-6">
        
        <div id="demoWarningCard" class="hidden bg-rose-50 border border-rose-200 p-5 rounded-[1.5rem] shadow-sm">
            <div class="flex items-start gap-4">
                <div class="w-10 h-10 bg-rose-100 text-rose-600 rounded-xl flex items-center justify-center shrink-0">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                </div>
                <div>
                    <h3 class="text-[13px] font-black text-rose-900 uppercase tracking-tight">Akaun Demo</h3>
                    <p class="text-[10px] font-bold text-rose-700 leading-relaxed mt-1">Anda sedang menggunakan akaun demo. Tetapan profil telah dikunci. Untuk membuka ciri penuh, sila hubungi admin.</p>
                    <button onclick="window.open('https://wa.me/60138491319?text=Saya%20ingin%20buka%20akaun%20penuh%20untuk%20NZ%20Cloud%20Repair%20Management%20System.', '_blank')" class="mt-3 bg-rose-600 hover:bg-rose-700 text-white px-4 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center justify-center gap-2 tap-effect shadow-md shadow-rose-600/20 w-full transition-colors">
                        <i data-lucide="message-circle" class="w-4 h-4"></i> Hubungi Admin
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white p-5 rounded-[1.5rem] shadow-sm border border-slate-200 flex items-center gap-5 relative overflow-hidden">
            <div class="absolute -right-4 -top-4 w-24 h-24 bg-slate-50 rounded-full opacity-50"></div>
            <div class="w-14 h-14 bg-slate-900 rounded-[1.2rem] flex items-center justify-center shadow-lg shadow-slate-900/20 shrink-0 z-10">
                <i data-lucide="user" class="w-6 h-6 text-white"></i>
            </div>
            <div class="z-10">
                <h2 id="userNameDisplay" class="text-sm font-black text-slate-900 uppercase leading-tight tracking-tight">Memuatkan...</h2>
                <p id="userRoleDisplay" class="text-[9px] font-black text-emerald-500 uppercase tracking-widest mt-1 bg-emerald-50 inline-block px-2 py-1 rounded-md">-</p>
                <p id="userEmailDisplay" class="text-[10px] font-bold text-slate-400 mt-1 font-num hidden"></p>
            </div>
        </div>

        <div class="space-y-3">
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">Profile Business</h3>
            
            <div class="bg-white p-5 rounded-[1.5rem] shadow-sm border border-slate-200 space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="input-label">Nama Kedai</label>
                        <input type="text" id="bizName" class="input-field" placeholder="-">
                    </div>
                    <div>
                        <label class="input-label">SSM Register</label>
                        <input type="text" id="bizSSM" class="input-field font-num" placeholder="-">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="input-label">No. Telefon / WA</label>
                        <input type="tel" id="bizPhone" class="input-field font-num" placeholder="-">
                    </div>
                    <div>
                        <label class="input-label">Waktu Operasi</label>
                        <input type="text" id="bizHours" class="input-field" placeholder="-">
                    </div>
                </div>
                <div>
                    <label class="input-label">Alamat Penuh</label>
                    <textarea id="bizAddress" rows="2" class="input-field resize-none leading-relaxed" placeholder="-"></textarea>
                </div>
                
                <div>
                    <label class="input-label">Logo</label>
                    <div class="flex items-center gap-4 mt-1">
                        <div class="w-14 h-14 bg-slate-50 rounded-xl border border-slate-200 flex items-center justify-center overflow-hidden shrink-0">
                            <img id="logoPreview" src="" class="w-full h-full object-cover hidden" alt="Logo">
                            <i id="logoPlaceholder" data-lucide="image" class="w-5 h-5 text-slate-300"></i>
                        </div>
                        <div class="flex-1">
                            <input type="file" id="bizLogoFile" accept="image/*" class="hidden" onchange="uploadLogo(event)">
                            <button type="button" id="btnUploadLogo" onclick="document.getElementById('bizLogoFile').click()" class="w-full bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 font-black uppercase text-[9px] px-3 py-3 rounded-xl tap-effect flex justify-center items-center gap-2 transition-colors">
                                <i data-lucide="upload-cloud" class="w-4 h-4 text-blue-500"></i> Muat Naik Gambar
                            </button>
                        </div>
                        <input type="hidden" id="bizLogoUrl" value="">
                    </div>
                </div>

                <button onclick="saveBusinessProfile()" id="btnSaveBiz" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-black uppercase text-[11px] py-3.5 rounded-xl flex items-center justify-center gap-2 tap-effect tracking-widest mt-2 shadow-lg shadow-slate-900/20 transition-colors">
                    <i data-lucide="save" class="w-4 h-4"></i> Simpan Maklumat
                </button>
            </div>
        </div>

        <div class="space-y-3">
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">Sistem App</h3>
            <div class="bg-white rounded-[1.5rem] shadow-sm border border-slate-200 overflow-hidden">
                <button onclick="clearCache()" class="w-full p-5 flex items-center justify-between tap-effect border-b border-slate-100 hover:bg-slate-50 transition-colors">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-blue-50 text-blue-500 rounded-xl flex items-center justify-center"><i data-lucide="refresh-cw" class="w-4 h-4"></i></div>
                        <div class="text-left">
                            <h4 class="text-[11px] font-black text-slate-900 uppercase">Clear Cache</h4>
                            <p class="text-[8px] font-bold text-slate-400 uppercase tracking-wider mt-0.5">Refresh Data</p>
                        </div>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i>
                </button>
                <div class="w-full p-5 flex items-center justify-between bg-slate-50/50">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-white border border-slate-200 text-slate-400 rounded-xl flex items-center justify-center shadow-sm"><i data-lucide="info" class="w-4 h-4"></i></div>
                        <div class="text-left">
                            <h4 class="text-[11px] font-black text-slate-900 uppercase">Version</h4>
                            <p class="text-[8px] font-bold text-slate-400 uppercase tracking-wider mt-0.5">NASZEX CLOUD RMS v2.0 PRO</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="pt-4 pb-8">
            <button onclick="logoutApp()" id="btnLogout" class="w-full bg-white border border-rose-200 text-rose-500 hover:bg-rose-50 p-4 rounded-2xl font-black uppercase text-[10px] tracking-widest tap-effect flex items-center justify-center gap-2 transition-colors shadow-sm">
                <i data-lucide="log-out" class="w-4 h-4"></i> Log Keluar Akaun
            </button>
        </div>
        
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

    <script>
        lucide.createIcons();

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBJdeEbuE9FlAeK4cJRaqiMkd7aa8EbwWE",
            authDomain: "rms-cloudnas.firebaseapp.com",
            databaseURL: "https://rms-cloudnas-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "rms-cloudnas",
            storageBucket: "rms-cloudnas.firebasestorage.app",
            messagingSenderId: "142738217487",
            appId: "1:142738217487:web:2c2a08c40b77447484a17a"
        };
        
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // --- GLOBAL VARIABLE UNTUK DEMO/GUEST ROLE ---
        let isGuest = false;

        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.replace('login.html');
            } else {
                isGuest = user.isAnonymous; // Role Check Check

                if (isGuest) {
                    // TUKAR PAPARAN KEPADA DEMO
                    document.getElementById('userNameDisplay').innerText = "Guest User";
                    document.getElementById('userRoleDisplay').innerText = "Akaun Demo";
                    document.getElementById('userRoleDisplay').className = "text-[9px] font-black text-rose-500 uppercase tracking-widest mt-1 bg-rose-50 inline-block px-2 py-1 rounded-md border border-rose-100";
                    
                    document.getElementById('demoWarningCard').classList.remove('hidden');
                    
                    // KUNCI SEMUA INPUT FORM (Disable)
                    const formInputs = ['bizName', 'bizSSM', 'bizPhone', 'bizHours', 'bizAddress', 'bizLogoFile'];
                    formInputs.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.disabled = true;
                            el.classList.add('opacity-60', 'cursor-not-allowed', 'bg-slate-100');
                        }
                    });

                    // KUNCI BUTANG UPLOAD GAMBAR
                    const btnUploadLogo = document.getElementById('btnUploadLogo');
                    if (btnUploadLogo) {
                        btnUploadLogo.disabled = true;
                        btnUploadLogo.classList.add('opacity-60', 'cursor-not-allowed', 'bg-slate-50');
                        btnUploadLogo.onclick = (e) => { e.preventDefault(); showToast("Tidak dibenarkan dalam Akaun Demo", "error"); };
                    }

                    // KUNCI BUTANG SIMPAN
                    const btnSave = document.getElementById('btnSaveBiz');
                    if (btnSave) {
                        btnSave.disabled = true;
                        btnSave.classList.add('opacity-50', 'cursor-not-allowed');
                        btnSave.classList.remove('hover:bg-slate-800', 'tap-effect');
                        btnSave.onclick = (e) => { e.preventDefault(); showToast("Akaun Demo tidak boleh simpan tetapan!", "error"); };
                    }

                } else {
                    // PAPARAN NORMAL UNTUK ADMIN
                    document.getElementById('userNameDisplay').innerText = "Admin NASZC";
                    document.getElementById('userRoleDisplay').innerText = "Administrator";
                    document.getElementById('userEmailDisplay').innerText = user.email;
                    document.getElementById('userEmailDisplay').classList.remove('hidden');
                    
                    document.getElementById('demoWarningCard').classList.add('hidden');
                }
                
                // Panggil data dari pangkalan data
                loadBusinessProfile();
            }
        });

        // ----------------------------------------
        // FUNGSI KONFIGURASI PERNIAGAAN & LOGO
        // ----------------------------------------
        async function loadBusinessProfile() {
            try {
                const doc = await db.collection('settings').doc('business_profile').get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('bizName').value = data.name || '';
                    document.getElementById('bizSSM').value = data.ssm || '';
                    document.getElementById('bizPhone').value = data.phone || '';
                    document.getElementById('bizHours').value = data.hours || '';
                    document.getElementById('bizAddress').value = data.address || '';
                    
                    const logoUrl = data.logoUrl || '';
                    document.getElementById('bizLogoUrl').value = logoUrl;
                    
                    if(logoUrl) {
                        const preview = document.getElementById('logoPreview');
                        preview.src = logoUrl;
                        preview.classList.remove('hidden');
                        document.getElementById('logoPlaceholder').classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error("Gagal muat profil: ", error);
            }
        }

        async function uploadLogo(event) {
            if (isGuest) return showToast("Fungsi disekat dalam Mod Akaun Demo", "error");
            
            const file = event.target.files[0];
            if (!file) return;

            const btn = document.getElementById('btnUploadLogo');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader" class="w-4 h-4 text-blue-500 animate-spin"></i> Memuat naik...`;
            btn.disabled = true;

            try {
                const storageRef = storage.ref(`logos/business_logo_${Date.now()}`);
                const snapshot = await storageRef.put(file);
                const url = await snapshot.ref.getDownloadURL();
                
                document.getElementById('bizLogoUrl').value = url;
                const preview = document.getElementById('logoPreview');
                preview.src = url;
                preview.classList.remove('hidden');
                document.getElementById('logoPlaceholder').classList.add('hidden');
                
                showToast("Logo berjaya dimuat naik!");
            } catch (error) {
                showToast("Gagal memuat naik logo", "error");
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                lucide.createIcons();
            }
        }

        async function saveBusinessProfile() {
            if (isGuest) return showToast("Fungsi disekat dalam Mod Akaun Demo", "error");
            
            const btn = document.getElementById('btnSaveBiz');
            btn.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Menyimpan...`;
            
            const bizData = {
                name: document.getElementById('bizName').value.trim(),
                ssm: document.getElementById('bizSSM').value.trim(),
                phone: document.getElementById('bizPhone').value.trim(),
                hours: document.getElementById('bizHours').value.trim(),
                address: document.getElementById('bizAddress').value.trim(),
                logoUrl: document.getElementById('bizLogoUrl').value.trim(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('settings').doc('business_profile').set(bizData, { merge: true });
                showToast("Profil bisnes berjaya disimpan.");
            } catch (error) {
                showToast("Gagal menyimpan data: " + error.message, "error");
            } finally {
                btn.innerHTML = `<i data-lucide="save" class="w-4 h-4"></i> Simpan Maklumat`;
                lucide.createIcons();
            }
        }

        // ----------------------------------------
        // FUNGSI LAIN-LAIN UTILITIES
        // ----------------------------------------
        function logoutApp() {
            const btn = document.getElementById('btnLogout');
            btn.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Memproses...`;
            auth.signOut().then(() => showToast("Log keluar berjaya.")).catch(error => {
                showToast("Ralat: " + error.message, "error");
                btn.innerHTML = `<i data-lucide="log-out" class="w-4 h-4"></i> Log Keluar Akaun`;
                lucide.createIcons();
            });
        }

        function clearCache() {
            showToast("Menyegarkan memori cache...");
            setTimeout(() => window.location.reload(true), 1000);
        }

        function showToast(msg, type='success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const icon = type === 'success' ? 'check-circle' : 'alert-circle';
            const color = type === 'success' ? 'text-emerald-400' : 'text-rose-400';
            toast.className = 'toast';
            toast.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4 ${color}"></i> <span>${msg}</span>`;
            container.appendChild(toast);
            lucide.createIcons();
            if(navigator.vibrate) navigator.vibrate(50);
            setTimeout(() => { toast.classList.add('out'); setTimeout(() => toast.remove(), 300); }, 3000);
        }
    </script>
</body>
</html>
