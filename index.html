<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    
    <title>NASZEX CLOUD - RMS v2.0 PRO</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #0f172a; --accent: #ef4444; }
        
        /* Buang kesan highlight/kelip biru bila tekan butang di mobile */
        * { -webkit-tap-highlight-color: transparent !important; outline: none !important; }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #f8fafc; color: #1e293b; 
            user-select: none; overscroll-behavior-y: none; -webkit-font-smoothing: antialiased;
        }
        
        .font-num { font-family: 'Inter', sans-serif; }
        .gpu { transform: translate3d(0,0,0); backface-visibility: hidden; perspective: 1000px; will-change: transform, opacity; }

        /* Modal Transitions */
        .modal-overlay { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 60; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        /* Fix modal stacking bug & ensure smooth scaling */
        .modal-wrapper { transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease; transform: translateY(110%) scale(0.95); opacity: 0; pointer-events: none; will-change: transform, opacity; z-index: 100; }
        .modal-wrapper.active { transform: translateY(0) scale(1); opacity: 1; pointer-events: auto; }

        /* Smooth View Transitions */
        .view-section { 
            display: none; 
            opacity: 0;
        }
        .view-section.active { 
            display: block; 
            animation: fadeInView 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        @keyframes fadeInView {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .list-anim { animation: slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; }

        .glass-nav { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-bottom { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-top: 1px solid rgba(226, 232, 240, 0.8); }
        
        .tap-effect { transition: transform 0.1s; cursor: pointer; }
        .tap-effect:active { transform: scale(0.95); }
        /* Prevent nav items from bouncing and causing layout shift */
        .nav-tap-effect { transition: color 0.2s; cursor: pointer; }
        
        .tab-active { background: #0f172a !important; color: #fff !important; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.15); }
        .nav-item-active { color: #0f172a !important; font-weight: 800; }

        .float-input-group { position: relative; width: 100%; transition: 0.3s; }
        .float-input-group label { position: absolute; top: 8px; left: 16px; font-size: 9px; font-weight: 800; color: #94a3b8; text-transform: uppercase; pointer-events: none; }
        .float-input-group input, .float-input-group select { padding-top: 24px; padding-bottom: 12px; }
        
        .input-label { font-size: 0.55rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 0.25rem; display: block; }

        #toast-container { position: fixed; top: calc(16px + env(safe-area-inset-top)); left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
        .toast { background: #0f172a; color: white; padding: 12px 24px; border-radius: 99px; font-size: 11px; font-weight: 700; box-shadow: 0 10px 30px rgba(0,0,0,0.15); animation: toastIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; transform: translateY(-20px); pointer-events: auto; display: flex; align-items: center; gap: 8px; }
        @keyframes toastIn { to { opacity: 1; transform: translateY(0); } }

        /* Fix safe-area handling for PWA nav bar */
        @supports (padding: max(0px)) {
            .safe-top { padding-top: max(0.75rem, env(safe-area-inset-top)) !important; }
            /* Memastikan padding bottom cukup tebal untuk elak overlap dengan home indicator */
            .safe-bottom { padding-bottom: max(1rem, env(safe-area-inset-bottom)) !important; }
            .modal-safe-bottom { padding-bottom: max(1.25rem, env(safe-area-inset-bottom)) !important; }
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .dash-card-gradient { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
    </style>
</head>
<body class="bg-[#f8fafc] overflow-x-hidden">

    <div id="toast-container"></div>

    <nav class="sticky top-0 z-40 glass-nav px-5 py-3 gpu safe-top">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center shadow-lg tap-effect">
                    <span class="text-slate-900 font-black text-[12px] italic">NX</span>
                </div>
                <div>
                    <h1 class="text-[14px] font-black italic uppercase tracking-[0.1em] text-white leading-none">NASZEX</h1>
                    <p class="text-[8px] font-bold text-slate-400 uppercase tracking-[0.3em] mt-1 leading-none">RMS v2.0 PRO</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="refreshData()" class="w-10 h-10 flex items-center justify-center bg-slate-800 hover:bg-slate-700 rounded-xl text-white border border-slate-700 tap-effect shadow-sm transition-colors" aria-label="Segarkan Data">
                    <i data-lucide="refresh-cw" id="refresh-icon" class="w-4 h-4"></i>
                </button>
                <button onclick="window.location.href='setting.html'" class="w-10 h-10 flex items-center justify-center bg-slate-800 hover:bg-slate-700 rounded-xl text-white border border-slate-700 tap-effect shadow-sm transition-colors" aria-label="Tetapan Sistem">
                    <i data-lucide="settings" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-md mx-auto relative pb-32 pt-2">
        
        <main id="dashboardView" class="view-section space-y-5 p-4 pt-4">
            
            <div class="flex justify-between items-end px-1">
                <div>
                    <h2 class="text-2xl font-black text-slate-900 tracking-tight">Hai üëã</h2>
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Status Now</p>
                </div>
                <div class="text-right">
                    <p class="text-xl font-black text-emerald-600 font-num" id="todayJobs">0</p>
                    <p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">Job</p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="dash-card-gradient rounded-[1.5rem] p-5 shadow-xl shadow-slate-900/10 text-white relative overflow-hidden tap-effect">
                    <div class="absolute -right-4 -top-4 w-20 h-20 bg-white/5 rounded-full"></div>
                    <div class="flex justify-between items-center mb-4 relative z-10">
                        <div class="w-8 h-8 bg-white/10 rounded-lg flex items-center justify-center"><i data-lucide="wallet" class="w-4 h-4 text-emerald-400"></i></div>
                        <span class="text-[9px] font-black uppercase tracking-widest text-emerald-400 bg-emerald-400/10 px-2 py-1 rounded-md border border-emerald-400/20">Paid</span>
                    </div>
                    <p class="text-2xl font-black font-num relative z-10 tracking-tight">RM <span id="stat-month-paid">0</span></p>
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mt-1 relative z-10">Hasil Bulan Ini</p>
                </div>
                
                <div class="bg-gradient-to-br from-white to-slate-50 border border-slate-200 rounded-[1.5rem] p-5 shadow-sm text-slate-900 relative overflow-hidden tap-effect">
                    <div class="flex justify-between items-center mb-4">
                        <div class="w-8 h-8 bg-rose-50 rounded-lg flex items-center justify-center border border-rose-100"><i data-lucide="alert-circle" class="w-4 h-4 text-rose-500"></i></div>
                        <span class="text-[9px] font-black uppercase tracking-widest text-rose-500 bg-rose-50 px-2 py-1 rounded-md border border-rose-100">Unpaid</span>
                    </div>
                    <p class="text-2xl font-black font-num tracking-tight">RM <span id="stat-month-pending">0</span></p>
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-wider mt-1">Pending</p>
                </div>
            </div>

            <div class="space-y-3 pt-2">
                <div class="relative group">
                    <input type="text" id="searchInput" onkeyup="handleSearch()" placeholder="Cari nama, phone atau item..." 
                           class="w-full pl-11 pr-4 py-4 bg-white border border-slate-200 rounded-2xl text-[11px] font-bold shadow-sm outline-none focus:border-slate-400 transition-all font-num tracking-wide">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 transition-colors group-focus-within:text-slate-900"></i>
                </div>

                <div class="flex p-1.5 bg-slate-200/50 rounded-2xl gap-1.5 backdrop-blur-md">
                    <button onclick="filterInvoices('all')" id="f-all" class="flex-1 py-2.5 rounded-xl text-[9px] font-black uppercase transition-all tab-active tap-effect">Semua</button>
                    <button onclick="filterInvoices('outstanding')" id="f-pending" class="flex-1 py-2.5 rounded-xl text-[9px] font-black uppercase transition-all text-slate-500 hover:text-slate-700 tap-effect">Unpaid</button>
                    <button onclick="filterInvoices('paid')" id="f-paid" class="flex-1 py-2.5 rounded-xl text-[9px] font-black uppercase transition-all text-slate-500 hover:text-slate-700 tap-effect">Paid</button>
                </div>
            </div>

            <div id="invoiceContainer" class="space-y-4 pb-8 min-h-[40vh]">
                </div>
        </main>

        <main id="reportsView" class="view-section p-4 pt-4 space-y-6">
            <div>
                <h2 class="text-2xl font-black text-slate-900 tracking-tight">Analitik Bisnes</h2>
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Data & Prestasi Kedai</p>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm text-center">
                    <div class="w-8 h-8 mx-auto bg-blue-50 text-blue-500 rounded-lg flex items-center justify-center mb-2"><i data-lucide="activity" class="w-4 h-4"></i></div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Kerosakan Utama</p>
                    <p id="topDamage" class="text-sm font-black text-slate-900 mt-1 uppercase truncate">-</p>
                </div>
                <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm text-center">
                    <div class="w-8 h-8 mx-auto bg-purple-50 text-purple-500 rounded-lg flex items-center justify-center mb-2"><i data-lucide="award" class="w-4 h-4"></i></div>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Model Tertinggi</p>
                    <p id="topModel" class="text-sm font-black text-slate-900 mt-1 uppercase truncate">-</p>
                </div>
            </div>

            <div class="space-y-3 pt-2">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">Laporan Terperinci</h3>
                
                <button onclick="toggleReportSection('profitReportBox')" class="w-full bg-white p-5 rounded-[1.5rem] shadow-sm border border-slate-200 flex items-center justify-between tap-effect">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center"><i data-lucide="trending-up"></i></div>
                        <div class="text-left">
                            <h3 class="text-sm font-black uppercase text-slate-900">Analisa Keuntungan</h3>
                            <p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mt-0.5">Hasil Kasar vs Untung Bersih</p>
                        </div>
                    </div>
                    <i data-lucide="chevron-down" class="w-5 h-5 text-slate-300"></i>
                </button>
                <div id="profitReportBox" class="hidden bg-white rounded-[1.5rem] border border-slate-200 overflow-hidden mt-2">
                     <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr><th class="pl-5 py-3 text-[9px] font-black uppercase text-slate-400">Bulan</th><th class="text-center text-[9px] font-black uppercase text-rose-400">Modal</th><th class="pr-5 text-right text-[9px] font-black uppercase text-emerald-500">Untung</th></tr>
                        </thead>
                        <tbody id="profitTableBody" class="text-[11px] font-bold font-num"></tbody>
                        <tfoot class="bg-slate-900 text-white font-num">
                            <tr><td class="pl-5 py-4 text-[9px] uppercase font-bold text-white/50">Total Untung</td><td colspan="2" id="total-net-profit" class="text-right pr-5 py-4 text-lg font-black italic">RM 0</td></tr>
                        </tfoot>
                    </table>
                </div>

                <button onclick="toggleReportSection('perfReportBox')" class="w-full bg-white p-5 rounded-[1.5rem] shadow-sm border border-slate-200 flex items-center justify-between tap-effect">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center"><i data-lucide="bar-chart-2"></i></div>
                        <div class="text-left">
                            <h3 class="text-sm font-black uppercase text-slate-900">Prestasi Bulanan</h3>
                            <p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mt-0.5">Volume Job & Kutipan</p>
                        </div>
                    </div>
                    <i data-lucide="chevron-down" class="w-5 h-5 text-slate-300"></i>
                </button>
                <div id="perfReportBox" class="hidden bg-white rounded-[1.5rem] border border-slate-200 overflow-hidden mt-2">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr><th class="pl-5 py-3 text-[9px] font-black uppercase text-slate-400">Bulan</th><th class="text-center text-[9px] font-black uppercase text-slate-400">Jobs</th><th class="pr-5 text-right text-[9px] font-black uppercase text-slate-400">Kutipan</th></tr>
                        </thead>
                        <tbody id="reportTableBody" class="text-slate-800 text-[11px] font-bold font-num"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <main id="toolsView" class="view-section p-4 pt-4 space-y-6">
            <div>
                <h2 class="text-2xl font-black text-slate-900 tracking-tight">Smart Tools</h2>
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">Price list & Generate</p>
            </div>

            <div class="space-y-4">
                
                <div class="bg-white rounded-[1.5rem] border border-slate-200 overflow-hidden shadow-sm">
                    <div class="bg-slate-50 px-5 py-4 border-b border-slate-100 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <i data-lucide="cpu" class="w-5 h-5 text-amber-500"></i>
                            <div>
                                <h3 class="text-[11px] font-black uppercase text-slate-900">Services</h3>
                                <p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">Price list</p>
                            </div>
                        </div>
                        <button onclick="openServiceModal()" class="text-[9px] font-black text-blue-500 uppercase tracking-widest bg-blue-50 px-2.5 py-1 rounded-md tap-effect">+ Tambah</button>
                    </div>
                    <div id="serviceCatalogList" class="divide-y divide-slate-50 max-h-60 overflow-y-auto">
                        <div class="p-5 text-center text-slate-400 text-[10px] font-bold tracking-widest uppercase">Memuatkan Data...</div>
                    </div>
                </div>

                <div class="bg-white rounded-[1.5rem] border border-slate-200 overflow-hidden shadow-sm mt-4">
                     <div class="bg-slate-50 px-5 py-4 border-b border-slate-100 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <i data-lucide="layers" class="w-5 h-5 text-emerald-500"></i>
                            <div>
                                <h3 class="text-[11px] font-black uppercase text-slate-900">Lcd / Battery / Backglass</h3>
                                <p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">Price & Part</p>
                            </div>
                        </div>
                        <button onclick="openMatrixModal()" class="text-[9px] font-black text-emerald-500 uppercase tracking-widest bg-emerald-50 px-2.5 py-1 rounded-md tap-effect">+ Tambah</button>
                    </div>
                    <div class="p-3 border-b border-slate-50">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                            <input type="text" id="searchBrand" onkeyup="filterMatrix()" class="w-full bg-slate-50 border border-slate-200 text-slate-900 text-[10px] font-bold uppercase rounded-xl py-2.5 pl-9 pr-3 outline-none focus:border-emerald-500 focus:bg-white transition-all placeholder:normal-case placeholder:font-medium" placeholder="Cari jenama... (cth: Apple)">
                        </div>
                    </div>
                    <div id="matrixCatalogList" class="grid grid-cols-2 gap-3 p-3 max-h-80 overflow-y-auto">
                        <div class="col-span-2 p-5 text-center text-slate-400 text-[10px] font-bold tracking-widest uppercase">Memuatkan Data...</div>
                    </div>
                </div>

                <div class="bg-slate-900 rounded-[1.5rem] overflow-hidden shadow-xl shadow-slate-900/20">
                    <div class="px-5 py-4 border-b border-white/10 flex items-center gap-3">
                        <i data-lucide="printer" class="w-5 h-5 text-white"></i>
                        <div>
                            <h3 class="text-[11px] font-black uppercase text-white">Generate Receipt</h3>
                            <p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">Print & Send</p>
                        </div>
                    </div>
                    <div class="p-5 space-y-4">
                         <input type="tel" id="toolReceiptPhone" placeholder="Masukkan No Phone Pelanggan..." class="w-full bg-white/10 border border-white/20 text-white rounded-xl p-4 font-bold outline-none font-num text-sm placeholder:text-white/40">
                         <div class="grid grid-cols-2 gap-3">
                            <button onclick="handleTools('whatsapp')" class="w-full bg-[#25D366] text-white py-3 rounded-xl font-black uppercase text-[10px] flex items-center justify-center gap-2 tap-effect"><i data-lucide="message-circle" class="w-4 h-4"></i> WhatsApp</button>
                            <button onclick="handleTools('pdf')" class="w-full bg-white text-slate-900 py-3 rounded-xl font-black uppercase text-[10px] flex items-center justify-center gap-2 tap-effect"><i data-lucide="download" class="w-4 h-4"></i> Download</button>
                         </div>
                    </div>
                </div>

            </div>
        </main>

    </div>

    <div class="fixed bottom-0 left-0 right-0 z-40 glass-bottom px-4 py-2 safe-bottom gpu border-t border-slate-200/50">
        <div class="max-w-md mx-auto grid grid-cols-4 items-center h-[60px] relative">
            <button onclick="window.location.hash='dashboard'" id="nav-dash" class="group flex flex-col items-center justify-center gap-1 nav-tap-effect transition-colors text-slate-900 nav-item-active">
                <i data-lucide="layout-grid" class="w-5 h-5 mb-0.5"></i>
                <span class="text-[9px] uppercase tracking-tight">Home</span>
            </button>
            
            <button onclick="window.location.hash='newjob'" class="group flex flex-col items-center justify-center gap-1 tap-effect text-slate-900 relative">
                <div class="w-12 h-12 bg-slate-900 text-white rounded-[1.2rem] flex items-center justify-center shadow-lg shadow-slate-900/30 border-4 border-[#f8fafc] absolute -top-4">
                     <i data-lucide="plus" class="w-5 h-5"></i>
                </div>
                <div class="h-5"></div>
            </button>
            
            <button onclick="window.location.hash='reports'" id="nav-reports" class="group flex flex-col items-center justify-center gap-1 nav-tap-effect text-slate-400 transition-colors">
                <i data-lucide="pie-chart" class="w-5 h-5 mb-0.5"></i>
                <span class="text-[9px] uppercase tracking-tight">Data</span>
            </button>
            
            <button onclick="window.location.hash='tools'" id="nav-tools" class="group flex flex-col items-center justify-center gap-1 nav-tap-effect text-slate-400 transition-colors">
                <i data-lucide="wrench" class="w-5 h-5 mb-0.5"></i>
                <span class="text-[9px] uppercase tracking-tight">Tools</span>
            </button>
        </div>
    </div>

    <div id="invoiceModal" class="fixed inset-0 z-50 bg-slate-950/60 backdrop-blur-md hidden modal-wrapper flex flex-col justify-end sm:justify-center gpu">
        <div class="bg-[#f8fafc] w-full max-w-md mx-auto h-[92dvh] sm:h-[85dvh] sm:rounded-3xl rounded-t-[2.5rem] shadow-2xl flex flex-col overflow-hidden relative">
            <div class="px-6 py-5 bg-white/80 backdrop-blur-md border-b border-slate-100 flex justify-between items-center shrink-0 sticky top-0 z-10">
                <div>
                    <h2 id="modalTitle" class="text-sm font-black uppercase text-slate-900">Initiate Job</h2>
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">new job</p>
                </div>
                <button onclick="toggleModal(false)" class="w-9 h-9 bg-slate-50 rounded-full flex items-center justify-center text-slate-400 border border-slate-100 tap-effect"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 space-y-6 no-scrollbar">
                <input type="hidden" id="editId">
                
                <div class="bg-white p-5 rounded-[1.5rem] shadow-sm border border-slate-100 space-y-4">
                    <div class="float-input-group">
                        <input type="text" id="custName" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 font-bold outline-none focus:bg-white focus:border-blue-400 transition-colors text-xs" autocomplete="off">
                        <label>Nama</label>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="float-input-group">
                            <input type="tel" id="custPhone" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 font-bold outline-none focus:bg-white focus:border-blue-400 text-xs font-num" autocomplete="off">
                            <label>No. WhatsApp</label>
                        </div>
                        <div class="float-input-group">
                            <select id="warranty" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 font-bold outline-none text-xs">
                                <option value="Tiada Waranti">Tiada Waranti</option>
                                <option value="7 Hari">7 Hari</option>
                                <option value="30 Hari">30 Hari</option>
                                <option value="90 Hari">90 Hari</option>
                            </select>
                            <label>Waranti</label>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between items-end px-1">
                        <h4 class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Services / Item</h4>
                        <button onclick="addRow()" class="text-[9px] font-bold text-white bg-slate-900 px-4 py-2 rounded-xl uppercase tracking-wide tap-effect shadow-md flex items-center gap-1">
                            <i data-lucide="plus" class="w-3 h-3"></i> Tambah Item
                        </button>
                    </div>
                    <div id="itemRowsContainer" class="space-y-3 pb-20"></div>
                </div>
            </div>

            <div class="p-5 bg-white border-t border-slate-100 shrink-0 modal-safe-bottom">
                <div class="flex justify-between items-center mb-4">
                    <select id="initialStatus" class="bg-slate-50 border border-slate-200 text-slate-700 py-2.5 px-4 rounded-xl text-[10px] font-black uppercase outline-none">
                        <option value="outstanding">Unpaid</option>
                        <option value="paid">Paid</option>
                    </select>
                    <div class="text-right">
                        <p class="text-[8px] font-bold text-slate-400 uppercase mb-0.5 tracking-widest">Jumlah Keseluruhan</p>
                        <p class="text-2xl font-black text-slate-900 italic font-num">RM <span id="grandTotal">0.00</span></p>
                    </div>
                </div>
                <button onclick="saveAndGenerate()" id="btnSave" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-black uppercase text-[11px] tracking-widest shadow-xl shadow-emerald-600/20 tap-effect flex items-center justify-center gap-2">
                    SAVE <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="actionModal" class="fixed inset-0 z-50 bg-slate-950/60 backdrop-blur-md hidden modal-wrapper flex flex-col justify-end gpu">
        <div class="bg-white rounded-t-[2.5rem] w-full p-6 pb-10 shadow-2xl space-y-5 modal-safe-bottom">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-2"></div>
            
            <div class="text-center">
                 <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Pengurusan Invois</p>
                 <h2 id="actionTargetName" class="font-black text-lg uppercase text-slate-900 italic mt-1 truncate px-4"></h2>
                 <p id="actionTargetNo" class="text-[10px] font-bold text-blue-500 font-num mt-0.5"></p>
            </div>
            
            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200 space-y-2">
                <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest block text-center">Update Status Repair</label>
                <select id="updateRepairStatus" onchange="updateLiveStatusAndNotify(activeId, this.value)" class="w-full bg-white border border-slate-300 rounded-xl p-3.5 text-xs font-black outline-none shadow-sm text-slate-800 text-center uppercase tracking-wider">
                    <option value="Received">üì• 1. Received (Dalam Giliran)</option>
                    <option value="Diagnosing">üîç 2. Diagnosing (Check)</option>
                    <option value="Waiting Part">üì¶ 3. Waiting Part (Tunggu Alat Ganti)</option>
                    <option value="In Repair">‚öôÔ∏è 4. In Repair (Sedang Dibaiki)</option>
                    <option value="Testing">üì± 5. Testing Mode (Pengujian)</option>
                    <option value="Completed">‚úÖ 6. Completed</option>
                    <option value="Collected">ü§ù 7. Collected</option>
                    <option value="Cancelled">‚ùå 8. Cancelled</option>
                </select>
                <p class="text-[8px] text-center text-slate-400 mt-2">*Perubahan status akan mencadangkan notifikasi WhatsApp.</p>
            </div>

            <div class="grid grid-cols-2 gap-3 pt-2">
                <button id="btnToggleStatus" class="col-span-2 p-4 rounded-2xl font-black text-[11px] uppercase shadow-md tap-effect flex justify-between items-center px-6 transition-all duration-300">
                </button>

                <button onclick="handleAction('receipt')" class="p-4 bg-slate-900 text-white rounded-2xl font-black text-[9px] uppercase shadow-lg shadow-slate-900/20 flex justify-center items-center gap-2 tap-effect">
                    <i data-lucide="printer" class="w-4 h-4"></i> Print / Send
                </button>
                <button onclick="handleAction('edit')" class="p-4 bg-white text-slate-700 rounded-2xl font-black text-[9px] uppercase border border-slate-200 flex justify-center items-center gap-2 tap-effect">
                    <i data-lucide="edit-3" class="w-4 h-4"></i> Edit
                </button>
            </div>
            
            <button onclick="handleAction('delete')" class="w-full py-4 text-rose-500 font-black text-[10px] uppercase tracking-widest tap-effect">
                Delete
            </button>
            <button onclick="closeActionMenu()" class="w-full bg-slate-100 py-3 text-[10px] font-bold text-slate-500 uppercase rounded-xl tracking-widest tap-effect">Tutup</button>
        </div>
    </div>

    <div id="serviceModal" class="fixed inset-0 z-[60] bg-slate-950/60 backdrop-blur-md hidden modal-wrapper flex flex-col justify-end sm:justify-center gpu">
        <div class="bg-white w-full max-w-md mx-auto rounded-t-[2.5rem] sm:rounded-3xl p-6 shadow-2xl modal-safe-bottom max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-sm font-black text-slate-900 uppercase">New Servis</h3>
                <button onclick="closeServiceModal()" class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 tap-effect">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="input-label">Jenis Servis</label>
                    <input type="text" id="svcName" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold outline-none text-xs" placeholder="Cth: Screen Replacement">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="input-label">Kategori</label>
                        <select id="svcCategory" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold outline-none text-xs">
                            <option value="Hardware">Hardware</option>
                            <option value="Software">Software</option>
                            <option value="Diagnostic">Diagnostik</option>
                        </select>
                    </div>
                    <div>
                        <label class="input-label">Caj / Upah (RM)</label>
                        <input type="number" id="svcLabor" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold outline-none text-xs font-num" placeholder="Cth: 50.00">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="input-label">Anggaran Masa</label>
                        <select id="svcTime" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold outline-none text-xs">
                            <option value="15-30 Minit">15-40 Minit</option>
                            <option value="1-2 Jam">1-2 Jam</option>
                            <option value="1-3 Hari">1-3 Hari</option>
                            <option value="Seminggu">3-7 Hari Bekerja</option>
                        </select>
                    </div>
                    <div>
                        <label class="input-label">Warranty Period</label>
                        <select id="svcWarranty" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold outline-none text-xs">
                            <option value="Tiada">Tiada Waranti</option>
                            <option value="7 Hari">7 Hari</option>
                            <option value="30 Hari">30 Hari</option>
                            <option value="90 Hari">90 Hari</option>
                        </select>
                    </div>
                </div>
                <button onclick="saveNewService()" id="btnSaveSvc" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black uppercase text-[10px] py-4 rounded-xl flex items-center justify-center gap-2 tap-effect tracking-widest mt-4 shadow-lg shadow-blue-600/20">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i> SAVE
                </button>
            </div>
        </div>
    </div>

    <div id="matrixModal" class="fixed inset-0 z-[60] bg-slate-950/60 backdrop-blur-md hidden modal-wrapper flex flex-col justify-end sm:justify-center gpu">
        <div class="bg-white w-full max-w-md mx-auto rounded-t-[2.5rem] sm:rounded-3xl p-6 shadow-2xl modal-safe-bottom max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-sm font-black text-slate-900 uppercase">Add New Matrix</h3>
                <button onclick="closeMatrixModal()" class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 tap-effect">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="input-label">Jenama (Brand)</label>
                        <input type="text" id="matBrand" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold outline-none text-xs" placeholder="-">
                    </div>
                    <div>
                        <label class="input-label">Model</label>
                        <input type="text" id="matModel" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold outline-none text-xs font-num" placeholder="-">
                    </div>
                </div>
                <div>
                    <label class="input-label">Jenis Part & Gred</label>
                    <input type="text" id="matGrade" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold outline-none text-xs" placeholder="Cth: LCD - OLED / Bateri - Ori">
                </div>
                <div>
                    <label class="input-label">Harga (RM)</label>
                    <input type="number" id="matPrice" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 font-bold outline-none text-xs font-num" placeholder="-">
                </div>
                <button onclick="saveNewMatrix()" id="btnSaveMat" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-black uppercase text-[10px] py-4 rounded-xl flex items-center justify-center gap-2 tap-effect tracking-widest mt-4 shadow-lg shadow-emerald-600/20">
                    <i data-lucide="layers" class="w-4 h-4"></i> SAVE
                </button>
            </div>
        </div>
    </div>

    <div id="brandDetailsModal" class="fixed inset-0 z-[60] bg-slate-950/60 backdrop-blur-md hidden modal-wrapper flex flex-col justify-end sm:justify-center gpu">
        <div class="bg-white w-full max-w-md mx-auto rounded-t-[2.5rem] sm:rounded-3xl p-6 shadow-2xl modal-safe-bottom max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-5 shrink-0">
                <div>
                    <h3 id="brandDetailsTitle" class="text-sm font-black text-slate-900 uppercase">Brand</h3>
                    <p class="text-[9px] font-bold text-slate-400 mt-0.5 uppercase tracking-widest">Senarai Sparepart</p>
                </div>
                <button onclick="closeBrandDetails()" class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 tap-effect">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <div id="brandDetailsList" class="overflow-y-auto space-y-2 flex-1 pb-4">
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => { 
            lucide.createIcons(); 
            handleRouting(); // Render routing awal-awal, tak perlu tunggu firebase
        });
        
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBJdeEbuE9FlAeK4cJRaqiMkd7aa8EbwWE",
            authDomain: "rms-cloudnas.firebaseapp.com",
            databaseURL: "https://rms-cloudnas-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "rms-cloudnas",
            storageBucket: "rms-cloudnas.firebasestorage.app",
            messagingSenderId: "142738217487",
            appId: "1:142738217487:web:2c2a08c40b77447484a17a"
        };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const auth = firebase.auth();
        const db = firebase.firestore();

        let allInvoices = [], currentFilter = 'all', activeId = null;
        let searchTimeout = null, unsubscribe = null;
        let businessProfile = {};
        let globalMatrixData = [];

        // --- ROUTING LOGIC ---
        function handleRouting() {
            let hash = window.location.hash.replace('#', '');
            if (!hash) hash = 'dashboard';

            if (['dashboard', 'reports', 'tools'].includes(hash)) {
                showPage(hash);
            } else if (hash === 'newjob') {
                showPage('dashboard');
                setTimeout(openAddModal, 50); 
                window.history.replaceState(null, null, '#dashboard'); 
            }
        }
        window.addEventListener('hashchange', handleRouting);

        // --- UI UTILS & VIEW TRANSITION ---
        function showPage(p) {
            const views = ['dashboardView', 'reportsView', 'toolsView'];
            const target = document.getElementById(p + 'View');
            
            if (!target || target.classList.contains('active')) return;

            views.forEach(v => {
                const el = document.getElementById(v);
                if (el) el.classList.remove('active');
            });
            target.classList.add('active');
            window.scrollTo({top: 0, behavior: 'instant'});

            document.querySelectorAll('button[id^="nav-"]').forEach(b => {
                b.classList.remove('nav-item-active');
                b.classList.add('text-slate-400');
            });
            const activeBtn = document.getElementById('nav-' + (p === 'dashboard' ? 'dash' : p));
            if(activeBtn) {
                activeBtn.classList.add('nav-item-active');
                activeBtn.classList.remove('text-slate-400');
            }
        }

        // --- INIT & AUTH ---
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.replace('login.html');
            } else {
                loadGlobalSettings();

                // Load Data Firebase
                if(unsubscribe) unsubscribe();
                unsubscribe = db.collection("invoices")
                    .where("uid", "==", user.uid)
                    .onSnapshot(s => {
                        allInvoices = s.docs.map(d=>({id:d.id, ...d.data()}))
                                                    .sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                        updateDashboard();
                        generateReport();
                        generateProfitReport();
                    });
                
                loadServiceCatalog();
                loadPricingMatrix();
            }
        });

        async function loadGlobalSettings() {
            try {
                const bp = await db.collection('settings').doc('business_profile').get();
                if(bp.exists) businessProfile = bp.data();
            } catch(e) { console.error("Error loading settings", e); }
        }

        function showToast(msg, type='success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const icon = type === 'success' ? 'check-circle' : 'alert-circle';
            const color = type === 'success' ? 'text-emerald-400' : 'text-rose-400';
            toast.className = 'toast';
            toast.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4 ${color}"></i> <span>${msg}</span>`;
            container.appendChild(toast);
            lucide.createIcons();
            if(navigator.vibrate) navigator.vibrate(50);
            setTimeout(() => { toast.classList.add('out'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function toggleReportSection(id) {
            const el = document.getElementById(id);
            if(el.classList.contains('hidden')) {
                el.classList.remove('hidden'); el.classList.add('list-anim');
            } else {
                el.classList.add('hidden'); el.classList.remove('list-anim');
            }
        }

        // --- DASHBOARD CORE ---
        function filterInvoices(type) {
            currentFilter = type;
            const ids = {all: 'f-all', paid: 'f-paid', outstanding: 'f-pending'};
            Object.keys(ids).forEach(k => {
                const el = document.getElementById(ids[k]);
                if(k === type) el.classList.add('tab-active'); else el.classList.remove('tab-active');
            });
            updateDashboard();
        }

        // Debounce Search Logic
        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => { updateDashboard(document.getElementById('searchInput').value); }, 300);
        }

        // Fungsi Salin/Share Link View
        async function shareInvoiceLink(event, id, invoiceNo) {
            event.stopPropagation(); // Elak trigger openActionMenu
            const link = `${window.location.origin}/view.html?id=${id}`;
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: `Invois ${invoiceNo}`,
                        text: `Sila klik pautan ini untuk melihat butiran invois / resit anda.`,
                        url: link
                    });
                } catch (err) {
                    // Fallback to clipboard if user cancelled share or share failed
                    copyToClipboard(link);
                }
            } else {
                copyToClipboard(link);
            }
        }

        function copyToClipboard(text) {
            if(navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => showToast("Link copied", "success"));
            } else {
                // Fallback for older browsers
                let textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-999999px";
                textArea.style.top = "-999999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast("Link copied", "success");
                } catch (err) {
                    showToast("Gagal menyalin link", "error");
                }
                textArea.remove();
            }
        }

        function updateDashboard(search = "") {
            const container = document.getElementById('invoiceContainer');
            const now = new Date();
            let mPaid=0, mPending=0, todayJ=0;

            allInvoices.forEach(i => {
                const d = i.createdAt?.toDate ? i.createdAt.toDate() : new Date();
                if(d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) {
                    if(i.status === 'paid') mPaid += parseFloat(i.total); else mPending += parseFloat(i.total);
                }
                if(d.getDate() === now.getDate() && d.getMonth() === now.getMonth()) todayJ++;
            });

            document.getElementById('stat-month-paid').innerText = Math.round(mPaid);
            document.getElementById('stat-month-pending').innerText = Math.round(mPending);
            document.getElementById('todayJobs').innerText = todayJ;

            let filtered = allInvoices.filter(i => {
                if(currentFilter !== 'all' && i.status !== currentFilter) return false;
                if(search) {
                    const q = search.toLowerCase();
                    const itemName = i.items && i.items[0] ? i.items[0].name.toLowerCase() : "";
                    return (i.customerName||"").toLowerCase().includes(q) || (i.customerPhone||"").includes(q) || itemName.includes(q);
                }
                return true;
            });

            // Fallback UI if empty
            container.innerHTML = filtered.length ? '' : `<div class="py-12 text-center text-slate-400 text-[10px] font-bold uppercase tracking-widest"><i data-lucide="inbox" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>Tiada Rekod Dijumpai</div>`;

            filtered.forEach((i, index) => {
                const isPaid = i.status === 'paid';
                // Redesign badge UI
                const statusBadge = isPaid 
                    ? `<span class="text-[9px] font-black uppercase px-2 py-1 rounded-md bg-emerald-50 text-emerald-600 border border-emerald-200">PAID</span>`
                    : `<span class="text-[9px] font-black uppercase px-2 py-1 rounded-md bg-rose-50 text-rose-500 border border-rose-200">UNPAID</span>`;
                
                const pColor = {
                    'Received': 'bg-slate-100 text-slate-600', 'Diagnosing': 'bg-purple-100 text-purple-600',
                    'Waiting Part': 'bg-amber-100 text-amber-600', 'In Repair': 'bg-blue-100 text-blue-600',
                    'Testing': 'bg-indigo-100 text-indigo-600', 'Completed': 'bg-emerald-400 text-white shadow-md shadow-emerald-400/40 animate-pulse',
                    'Collected': 'bg-slate-900 text-white shadow-md shadow-slate-900/40', 'Cancelled': 'bg-rose-100 text-rose-600'
                };
                const badgeColor = pColor[i.repairStatus] || 'bg-slate-100 text-slate-600';
                const delay = index < 10 ? index * 0.05 : 0; 
                
                let deviceDesc = "Servis Umum";
                if(i.items && i.items.length > 0) deviceDesc = i.items[0].name.substring(0,30);
                
                const d = i.createdAt?.toDate ? i.createdAt.toDate() : new Date();
                const dateStr = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
                
                container.insertAdjacentHTML('beforeend', `
                <div onclick="openActionMenu('${i.id}')" style="animation-delay: ${delay}s" class="list-anim bg-gradient-to-br from-white to-slate-50/50 p-4 rounded-[1.5rem] shadow-sm hover:shadow-md border border-slate-200/60 tap-effect relative overflow-hidden group transition-all">
                    ${i.repairStatus === 'Completed' ? '<div class="absolute left-0 top-0 bottom-0 w-1.5 bg-emerald-400"></div>' : ''}
                    
                    <button onclick="shareInvoiceLink(event, '${i.id}', '${i.invoiceNo}')" class="absolute top-3 right-3 w-8 h-8 bg-white border border-slate-100 shadow-sm text-slate-400 hover:text-blue-500 rounded-full flex items-center justify-center transition-colors z-10" aria-label="Dapatkan Link View">
                        <i data-lucide="link" class="w-3.5 h-3.5"></i>
                    </button>

                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-[1.2rem] ${badgeColor} flex flex-col items-center justify-center shrink-0">
                            <i data-lucide="wrench" class="w-5 h-5 mb-0.5 opacity-90"></i>
                        </div>
                        <div class="flex-1 pr-6">
                            <h4 class="text-[12px] font-black uppercase text-slate-900 leading-tight truncate">${i.customerName}</h4>
                            <p class="text-[10px] font-bold text-slate-500 mt-0.5 truncate">${deviceDesc}</p>
                            <p class="text-[8px] font-bold text-slate-400 mt-1 uppercase tracking-wider">${dateStr} ‚Ä¢ ${(i.repairStatus||'NEW').substring(0,10)}</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-end mt-4 pt-3 border-t border-slate-100">
                        ${statusBadge}
                        <p class="text-[15px] font-black italic text-slate-900 font-num">RM ${Math.round(i.total)}</p>
                    </div>
                </div>`);
            });
            lucide.createIcons();
            updateTopAnalytics();
        }

        // --- PIPELINE & WHATSAPP LOGIC ---
        async function updateLiveStatusAndNotify(id, newStatus) {
            const i = allInvoices.find(x=>x.id===id);
            if(!i) return;
            
            await db.collection("invoices").doc(id).update({repairStatus: newStatus}); 
            i.repairStatus = newStatus;
            updateDashboard();
            
            if(confirm(`Status dikemaskini ke: ${newStatus}.\nBuka WhatsApp untuk maklumkan pelanggan?`)) {
                let msg = "";
                const name = i.customerName;
                const total = i.total;
                const bizName = businessProfile.name || "NASZEX CLOUD";
                
                switch(newStatus) {
                    case 'Received': msg = `Salam ${name}, device anda telah diterima dan berada dalam giliran. No Rujukan: ${i.invoiceNo}.`; break;
                    case 'Diagnosing': msg = `Salam ${name}, device anda sedang diperiksa oleh technician kami di ${bizName}. Kami akan maklumkan punca kerosakan sebentar lagi.`; break;
                    case 'Waiting Part': msg = `Salam ${name}, pihak ${bizName} kini sedang menunggu alat ganti (sparepart) tiba untuk device anda. Harap maklum.`; break;
                    case 'In Repair': msg = `Salam ${name}, device anda sekarang dalam proses repair.`; break;
                    case 'Testing': msg = `Salam ${name}, device anda sudah siap dibaiki, sekarang dalam test mode bagi memastikan semuanya berfungsi dengan baik.`; break;
                    case 'Completed': msg = `*SIAP DIBAIKI!*\n\nSalam ${name}, peranti anda telah siap sepenuhnya dan boleh di ambil. \n\nJumlah Bil: *RM ${total}*\n\nTerima kasih atas kesabaran anda!`; break;
                    case 'Collected': msg = `Terima kasih ${name} kerana menggunakan perkhidmatan repair di ${bizName}. Sila simpan resit ini untuk rujukan waranti anda.`; break;
                    case 'Cancelled': msg = `Salam ${name}, device anda (No: ${i.invoiceNo}), proses repair terpaksa dibatalkan. Sila hubungi kami untuk maklumat lanjut.`; break;
                    default: msg = `Salam ${name}, status terkini peranti anda: ${newStatus}.`;
                }
                
                const url = `https://wa.me/60${i.customerPhone.replace(/^0+/,'')}?text=${encodeURIComponent(msg)}`;
                window.open(url, '_blank');
            }
            closeActionMenu();
        }

        // --- FORM & CALCULATION ---
        function createItemRow(d = {}) {
            return `
            <div class="item-entry bg-white p-3.5 rounded-[1.2rem] border border-slate-200 relative mb-3 shadow-sm list-anim">
                <button onclick="this.closest('.item-entry').remove(); calculateTotal();" class="absolute -top-2 -right-2 bg-rose-500 text-white rounded-full w-6 h-6 shadow-md border-2 border-white flex items-center justify-center tap-effect z-10"><i data-lucide="x" class="w-3 h-3"></i></button>
                <div class="space-y-2 mb-2">
                    <input type="text" class="item-name w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-xs font-bold outline-none focus:bg-white focus:border-blue-400 transition-colors placeholder:text-slate-400" placeholder="Item / Part" value="${d.name || ''}">
                    <textarea class="item-desc w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-[10px] font-medium outline-none focus:bg-white transition-colors resize-none h-12 placeholder:text-slate-400" placeholder="Desc...">${d.description || ''}</textarea>
                </div>
                <div class="grid grid-cols-4 gap-2">
                    <div class="float-input-group"><input type="number" oninput="calculateTotal()" class="qty w-full bg-slate-50 border border-slate-200 rounded-lg px-1 text-center font-bold text-[11px] font-num" value="${d.qty || 1}"><label class="w-full text-center">Qty</label></div>
                    <div class="float-input-group"><input type="number" step="0.01" oninput="calculateTotal()" class="kos w-full bg-slate-50 border border-slate-200 rounded-lg px-1 text-center font-bold text-[11px] font-num" value="${d.kos || ''}"><label class="w-full text-center text-slate-500">Harga</label></div>
                    <div class="float-input-group"><input type="number" step="0.01" class="modal-price w-full bg-slate-50 border border-slate-200 rounded-lg px-1 text-center font-bold text-[11px] text-rose-500 font-num" value="${d.modal || ''}"><label class="w-full text-center text-rose-400">Modal</label></div>
                    <div class="float-input-group"><input type="number" step="0.01" oninput="calculateTotal()" class="discount w-full bg-slate-50 border border-slate-200 rounded-lg px-1 text-center font-bold text-[11px] text-blue-500 font-num" value="${d.discount || ''}"><label class="w-full text-center text-blue-400">Diskaun</label></div>
                </div>
            </div>`;
        }

        function addRow() {
            const container = document.getElementById('itemRowsContainer');
            if(!container) return; // Guard
            container.insertAdjacentHTML('beforeend', createItemRow());
            lucide.createIcons();
            container.parentElement.scrollTo({ top: container.parentElement.scrollHeight, behavior: 'smooth' });
        }

        function calculateTotal() {
            let t = 0;
            document.querySelectorAll('.item-entry').forEach(r => {
                const q = parseFloat(r.querySelector('.qty').value)||0, k = parseFloat(r.querySelector('.kos').value)||0, d = parseFloat(r.querySelector('.discount').value)||0;
                t += (q * k) - d;
            });
            document.getElementById('grandTotal').innerText = t.toFixed(2);
        }

        async function saveAndGenerate() {
            const btn = document.getElementById('btnSave');
            btn.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Menyimpan...`; lucide.createIcons();
            
            const n = document.getElementById('custName').value.trim(), p = document.getElementById('custPhone').value.trim();
            if(!n || !p) { showToast("Sila isi Nama & No. WA!", "error"); btn.innerHTML = `SAVE <i data-lucide="arrow-right" class="w-4 h-4"></i>`; lucide.createIcons(); return; }
            
            const items = [];
            document.querySelectorAll('.item-entry').forEach(r => {
                const name = r.querySelector('.item-name').value;
                if(name) items.push({
                    name: name,
                    description: r.querySelector('.item-desc').value.trim(),
                    qty: parseFloat(r.querySelector('.qty').value)||1, kos: parseFloat(r.querySelector('.kos').value)||0,
                    modal: parseFloat(r.querySelector('.modal-price').value)||0, discount: parseFloat(r.querySelector('.discount').value)||0
                });
            });

            if(items.length === 0) { showToast("Sila masukkan sekurang-kurangnya 1 item!", "error"); btn.innerHTML = `SAVE <i data-lucide="arrow-right" class="w-4 h-4"></i>`; lucide.createIcons(); return; }

            const user = firebase.auth().currentUser;
            if(!user) return; // Guard
            
            const data = {
                uid: user.uid, customerName: n, customerPhone: p, warranty: document.getElementById('warranty').value,
                status: document.getElementById('initialStatus').value, total: document.getElementById('grandTotal').innerText, items: items
            };
            const editId = document.getElementById('editId').value;
            
            try {
                if(editId) { 
                    await db.collection("invoices").doc(editId).update(data); 
                    showToast("Rekod Dikemaskini");
                }
                else {
                    const prefix = 'INV-';
                    const lastNo = allInvoices.reduce((max, i) => {
                        let num = 0;
                        if(i.invoiceNo && i.invoiceNo.includes('-')) num = parseInt(i.invoiceNo.split('-')[1]);
                        return Math.max(max, isNaN(num) ? 0 : num);
                    }, 0);
                    data.invoiceNo = prefix + (lastNo + 1).toString().padStart(4, '0');
                    data.repairStatus = 'Received'; 
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection("invoices").add(data);
                    showToast("Job Sheet Berjaya Dicipta!");
                    
                    if(confirm("Buka WhatsApp untuk hantar resit awal kepada pelanggan?")) {
                        const msg = `Salam ${n}, terima kasih berurusan dengan kami. Peranti anda telah didaftarkan dengan No. Rujukan: ${data.invoiceNo}. Kami akan maklumkan status terkini dari masa ke semasa.`;
                        window.open(`https://wa.me/60${p.replace(/^0+/,'')}?text=${encodeURIComponent(msg)}`, '_blank');
                    }
                }
                toggleModal(false);
            } catch(e) { console.error(e); showToast("Ralat Sistem", "error"); }
            btn.innerHTML = `SAVE <i data-lucide="arrow-right" class="w-4 h-4"></i>`; lucide.createIcons();
        }

        // --- SMART RECEIPT (PDF) ---
        function generateInvoicePDF(inv) {
            if(!inv) return; // Guard clause
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.width;

            doc.setFillColor(15, 23, 42); doc.rect(0, 0, pageWidth, 45, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22); doc.setFont("helvetica", "bold"); 
            doc.text(businessProfile.name || "NASZEX CLOUD", 15, 20);
            doc.setFontSize(10); doc.setFont("helvetica", "normal"); 
            doc.text("Professional Device Repair Center", 15, 26);
            
            doc.setFontSize(9);
            const addr = businessProfile.address || "Ara Kuda, Penang";
            const splittedAddr = doc.splitTextToSize(addr, 70);
            doc.text(splittedAddr, pageWidth - 15, 18, { align: "right" });
            doc.text(`SSM: ${businessProfile.ssm || '-'}`, pageWidth - 15, 30, { align: "right" });
            doc.text(`Tel/WA: ${businessProfile.phone || '-'}`, pageWidth - 15, 35, { align: "right" });

            doc.setTextColor(30, 41, 59); doc.setFontSize(18); doc.setFont("helvetica", "bold"); 
            const docType = inv.status === 'paid' ? "OFFICIAL RECEIPT" : "INVOICE";
            doc.text(docType, 15, 60);
            
            doc.setFontSize(10); doc.setFont("helvetica", "normal");
            doc.text(`No. Rujukan: ${inv.invoiceNo}`, 15, 68);
            const d = inv.createdAt?.toDate ? inv.createdAt.toDate() : new Date();
            doc.text(`Tarikh: ${d.toLocaleDateString('ms-MY')}`, 15, 74);
            doc.text(`Status: ${inv.status.toUpperCase()}`, 15, 80);

            doc.setFont("helvetica", "bold"); doc.text("KEPADA:", 120, 68);
            doc.setFont("helvetica", "normal"); 
            doc.text(inv.customerName, 120, 74); 
            doc.text(`Telefon: ${inv.customerPhone}`, 120, 80);

            const rows = (inv.items||[]).map(x => [
                x.name + (x.description ? `\n( ${x.description} )` : ''), 
                x.qty, 
                `RM ${parseFloat(x.kos).toFixed(2)}`, 
                `RM ${parseFloat(x.discount).toFixed(2)}`, 
                `RM ${((x.qty*x.kos)-x.discount).toFixed(2)}`
            ]);

            doc.autoTable({
                startY: 95,
                head: [['Perkara / Kerosakan', 'Unit', 'Harga (RM)', 'Diskaun', 'Jumlah (RM)']],
                body: rows,
                theme: 'grid',
                headStyles: { fillColor: [15, 23, 42], textColor: 255, fontStyle: 'bold' },
                styles: { fontSize: 9 }
            });

            let finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(14); doc.setFont("helvetica", "bold");
            doc.text(`JUMLAH: RM ${parseFloat(inv.total).toFixed(2)}`, 130, finalY);
            
            doc.setFontSize(9); doc.setTextColor(100); doc.setFont("helvetica", "normal");
            doc.text(`Waranti: ${inv.warranty || 'Tiada'}`, 15, finalY);

            doc.setFontSize(8); doc.setTextColor(150);
            let termY = 260;
            doc.text("TERMA & SYARAT:", 15, termY);
            termY += 5;
            const customNotes = [
                "1. Waranti hanya meliputi kerosakan pada komponen yang ditukar sahaja.",
                "2. Pihak kami tidak bertanggungjawab atas kehilangan data pengguna.",
                "3. Peranti yang tidak dituntut selepas 90 hari akan dilupuskan."
            ];
            doc.text(customNotes, 15, termY);

            doc.save(`${inv.invoiceNo}-${inv.customerName}.pdf`);
            showToast("Dokumen PDF Berjaya Dijana");
        }

        function handleTools(act) {
            const p = document.getElementById('toolReceiptPhone').value.trim();
            if(!p) return showToast("Sila masukkan no phone", "error");
            const match = allInvoices.filter(i => i.customerPhone.includes(p)).sort((a,b)=>{
                const dA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
                const dB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
                return dB - dA;
            })[0];
            
            if(!match) return showToast("Tiada rekod dijumpai", "error");
            if(act === 'whatsapp') {
                const msg = `Salam ${match.customerName}, berikut adalah status peranti anda:\nNo: ${match.invoiceNo}\nStatus: ${match.repairStatus}\nTotal: RM${match.total}`;
                window.open(`https://wa.me/60${p.replace(/^0+/,'')}?text=${encodeURIComponent(msg)}`); 
            } else {
                generateInvoicePDF(match);
            }
        }

        // --- DATA ANALYTICS ---
        function updateTopAnalytics() {
            let partsCount = {};
            allInvoices.forEach(inv => {
                (inv.items||[]).forEach(it => {
                    const name = it.name.trim().toUpperCase();
                    if(name) partsCount[name] = (partsCount[name]||0) + 1;
                });
            });
            let topDmg = "-", max = 0;
            for(let key in partsCount) { if(partsCount[key] > max) { max = partsCount[key]; topDmg = key; } }
            document.getElementById('topDamage').innerText = topDmg;
            document.getElementById('topModel').innerText = topDmg !== "-" ? `${max} Kes` : "-"; 
        }

        function generateReport() {
            const tb = document.getElementById('reportTableBody'), mo = ["Jan", "Feb", "Mac", "Apr", "Mei", "Jun", "Jul", "Ogo", "Sep", "Okt", "Nov", "Dis"];
            let h = "";
            const currentYear = new Date().getFullYear();
            mo.forEach((m, i) => {
                const monthly = allInvoices.filter(inv => { const d = inv.createdAt?.toDate ? inv.createdAt.toDate() : new Date(); return d.getMonth() === i && d.getFullYear() === currentYear; });
                const pS = monthly.reduce((s, inv) => inv.status === 'paid' ? s + parseFloat(inv.total) : s, 0);
                if (monthly.length > 0) h += `<tr class="border-b border-slate-50 last:border-0"><td class="pl-5 py-4 text-slate-600 uppercase font-black text-[10px]">${m}</td><td class="text-center text-slate-500 font-bold">${monthly.length}</td><td class="text-right pr-5 text-slate-800 font-black">RM ${Math.round(pS)}</td></tr>`;
            });
            tb.innerHTML = h || '<tr><td colspan="3" class="text-center py-8 text-xs font-bold text-slate-400">Tiada Data</td></tr>';
        }

        function generateProfitReport() {
            const tb = document.getElementById('profitTableBody'), mo = ["Jan", "Feb", "Mac", "Apr", "Mei", "Jun", "Jul", "Ogo", "Sep", "Okt", "Nov", "Dis"];
            let h = "", totalNett = 0;
            const currentYear = new Date().getFullYear();
            mo.forEach((m, i) => {
                const monthly = allInvoices.filter(inv => { const d = inv.createdAt?.toDate ? inv.createdAt.toDate() : new Date(); return d.getMonth() === i && d.getFullYear() === currentYear && inv.status === 'paid'; });
                let mModal = 0, mRev = 0;
                monthly.forEach(inv => { mRev += parseFloat(inv.total); (inv.items || []).forEach(it => { mModal += (parseFloat(it.modal)||0) * (parseFloat(it.qty)||1); }); });
                const mProfit = mRev - mModal; totalNett += mProfit;
                if(mRev > 0) h += `<tr class="border-b border-slate-50 last:border-0"><td class="pl-5 py-4 text-slate-600 uppercase font-black text-[10px]">${m}</td><td class="text-center text-rose-500 font-bold">RM ${Math.round(mModal)}</td><td class="text-right pr-5 text-emerald-600 font-black">RM ${Math.round(mProfit)}</td></tr>`;
            });
            tb.innerHTML = h || '<tr><td colspan="3" class="text-center py-8 text-xs font-bold text-slate-400">Tiada Data</td></tr>';
            document.getElementById('total-net-profit').innerText = `RM ${Math.round(totalNett)}`;
        }

        // --- MODAL UTILS & ACTIONS ---
        function toggleModal(show) {
            const m = document.getElementById('invoiceModal');
            if(show) { m.classList.remove('hidden'); requestAnimationFrame(()=>m.classList.add('active')); }
            else { m.classList.remove('active'); setTimeout(()=>m.classList.add('hidden'), 300); }
        }
        function openAddModal() {
            document.getElementById('modalTitle').innerText = "Initiate Job";
            document.getElementById('editId').value = "";
            document.getElementById('custName').value = ""; document.getElementById('custPhone').value = "";
            document.getElementById('itemRowsContainer').innerHTML = ""; addRow();
            document.getElementById('grandTotal').innerText = "0.00"; toggleModal(true);
        }
        function openActionMenu(id) {
            activeId = id; const i = allInvoices.find(x=>x.id===id); if (!i) return;
            document.getElementById('actionTargetName').innerText = i.customerName;
            document.getElementById('actionTargetNo').innerText = "Rujukan: " + i.invoiceNo;
            document.getElementById('updateRepairStatus').value = i.repairStatus || 'Received';
            const btn = document.getElementById('btnToggleStatus'); btn.onclick = null;
            if (i.status === 'paid') {
                btn.className = "col-span-2 p-4 bg-slate-50 text-slate-700 border border-slate-200 rounded-2xl font-black text-[10px] uppercase shadow-sm tap-effect flex justify-between items-center px-6 transition-all";
                btn.innerHTML = `<span>Tukar ke UNPAID</span><i data-lucide="rotate-ccw" class="w-4 h-4 text-slate-400"></i>`;
                btn.onclick = async () => { await db.collection("invoices").doc(id).update({status: 'outstanding'}); i.status = 'outstanding'; updateDashboard(); showToast("Status Ditukar: UNPAID"); closeActionMenu(); };
            } else {
                btn.className = "col-span-2 p-4 bg-emerald-500 text-white rounded-2xl font-black text-[10px] uppercase shadow-lg shadow-emerald-500/30 tap-effect flex justify-between items-center px-6 transition-all";
                btn.innerHTML = `<span>Sahkan BAYARAN (PAID)</span><i data-lucide="check-circle" class="w-4 h-4 text-white"></i>`;
                btn.onclick = async () => { await db.collection("invoices").doc(id).update({status: 'paid'}); i.status = 'paid'; updateDashboard(); showToast("Bayaran Disahkan!"); closeActionMenu(); };
            }
            const m = document.getElementById('actionModal'); m.classList.remove('hidden'); requestAnimationFrame(()=>m.classList.add('active')); lucide.createIcons();
        }
        function closeActionMenu() { const m = document.getElementById('actionModal'); m.classList.remove('active'); setTimeout(()=>m.classList.add('hidden'), 300); }
        
        function handleAction(type) {
            if(type === 'edit') {
                const i = allInvoices.find(x=>x.id===activeId); if(!i) return;
                document.getElementById('editId').value = activeId;
                document.getElementById('modalTitle').innerText = "Kemaskini Maklumat";
                document.getElementById('custName').value = i.customerName;
                document.getElementById('custPhone').value = i.customerPhone;
                document.getElementById('warranty').value = i.warranty || 'Tiada Waranti';
                document.getElementById('initialStatus').value = i.status;
                const cont = document.getElementById('itemRowsContainer'); cont.innerHTML = "";
                (i.items||[]).forEach(it => { cont.insertAdjacentHTML('beforeend', createItemRow(it)); });
                calculateTotal(); closeActionMenu(); setTimeout(() => toggleModal(true), 300);
            }
            if(type === 'delete' && confirm("Anda pasti mahu hapus rekod ini secara kekal?")) { 
                db.collection("invoices").doc(activeId).delete(); showToast("Rekod Dihapus"); closeActionMenu();
            }
            if(type === 'receipt') { generateInvoicePDF(allInvoices.find(x=>x.id===activeId)); closeActionMenu(); }
        }

        // --- TOOLS: KATALOG SERVIS & MATRIKS HARGA LOGIC ---
        // Implementation for Service Catalog added as it was missing previously
        async function loadServiceCatalog() {
            const listContainer = document.getElementById('serviceCatalogList');
            if(!listContainer) return;
            try {
                // Skeleton loading state
                listContainer.innerHTML = `<div class="p-5 text-center text-slate-400 text-[10px] animate-pulse uppercase tracking-widest font-bold">Memuatkan Katalog...</div>`;
                db.collection('settings').doc('service_catalog').collection('items').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        listContainer.innerHTML = `<div class="p-5 text-center text-slate-400 text-[10px] font-bold tracking-widest uppercase">Tiada Servis Didaftarkan</div>`;
                        return;
                    }
                    let html = '';
                    snapshot.forEach(doc => {
                        const s = doc.data();
                        html += `
                        <div class="px-5 py-4 flex justify-between items-center group hover:bg-slate-50 transition-colors border-b border-slate-50 last:border-0">
                            <div>
                                <h4 class="text-[11px] font-black text-slate-900 uppercase">${s.name}</h4>
                                <p class="text-[9px] font-bold text-slate-500 mt-0.5">${s.category} ‚Ä¢ ${s.estTime}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[11px] font-black text-slate-900 font-num">RM ${parseFloat(s.laborBase).toFixed(2)}</p>
                                <button onclick="deleteService('${doc.id}')" class="text-[8px] text-rose-400 hover:text-rose-600 font-bold uppercase tracking-widest mt-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">Padam</button>
                            </div>
                        </div>`;
                    });
                    listContainer.innerHTML = html;
                }, err => {
                    console.error("Error loading service catalog:", err);
                    listContainer.innerHTML = `<div class="p-5 text-center text-rose-500 text-[10px] font-bold">Gagal memuat katalog</div>`;
                });
            } catch (error) {
                console.error("Fail safely:", error);
            }
        }

        function openServiceModal() { 
            const m = document.getElementById('serviceModal');
            m.classList.remove('hidden');
            requestAnimationFrame(() => m.classList.add('active'));
        }
        
        function closeServiceModal() { 
            const m = document.getElementById('serviceModal');
            m.classList.remove('active');
            setTimeout(() => m.classList.add('hidden'), 300);
            document.getElementById('svcName').value = ''; 
            document.getElementById('svcLabor').value = ''; 
        }

        async function saveNewService() {
            const name = document.getElementById('svcName').value.trim(), category = document.getElementById('svcCategory').value;
            const laborBase = document.getElementById('svcLabor').value.trim(), estTime = document.getElementById('svcTime').value, warranty = document.getElementById('svcWarranty').value;
            if (!name || !laborBase) return showToast("Sila isi Nama Servis dan Caj Asas!", "error");
            
            const btn = document.getElementById('btnSaveSvc'); btn.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Memproses...`; lucide.createIcons();
            try {
                await db.collection('settings').doc('service_catalog').collection('items').add({ name, category, laborBase: parseFloat(laborBase), estTime, warranty, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                showToast("Servis ditambah!"); closeServiceModal();
            } catch (error) { showToast("Ralat menyimpan data", "error"); } 
            finally { btn.innerHTML = `<i data-lucide="plus-circle" class="w-4 h-4"></i> SAVE`; lucide.createIcons(); }
        }

        async function deleteService(id) { if(confirm("Padam servis ini dari katalog?")) { try { await db.collection('settings').doc('service_catalog').collection('items').doc(id).delete(); showToast("Servis dipadam."); } catch (error) { showToast("Gagal memadam servis.", "error"); } } }

        function openMatrixModal() { 
            const m = document.getElementById('matrixModal');
            m.classList.remove('hidden');
            requestAnimationFrame(() => m.classList.add('active'));
        }
        
        function closeMatrixModal() { 
            const m = document.getElementById('matrixModal');
            m.classList.remove('active');
            setTimeout(() => m.classList.add('hidden'), 300);
            document.getElementById('matBrand').value = ''; 
            document.getElementById('matModel').value = ''; 
            document.getElementById('matGrade').value = ''; 
            document.getElementById('matPrice').value = ''; 
        }

        async function loadPricingMatrix() {
            const listContainer = document.getElementById('matrixCatalogList');
            if(!listContainer) return;
            try {
                // Skeleton loading state
                listContainer.innerHTML = `<div class="col-span-2 p-5 text-center text-slate-400 text-[10px] animate-pulse tracking-widest uppercase font-bold">Memuatkan Matriks...</div>`;
                db.collection('settings').doc('pricing_matrix').collection('items').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                    globalMatrixData = []; const brandsMap = {}; 
                    if (snapshot.empty) { listContainer.innerHTML = `<div class="col-span-2 p-5 text-center text-slate-400 text-[10px] font-bold tracking-widest uppercase">Tiada Matriks Didaftarkan</div>`; return; }
                    snapshot.forEach(doc => {
                        const m = doc.data(); m.id = doc.id; globalMatrixData.push(m);
                        const brandName = m.brand.toUpperCase(); if(!brandsMap[brandName]) brandsMap[brandName] = []; brandsMap[brandName].push(m);
                    });
                    listContainer.innerHTML = '';
                    for (let brand in brandsMap) {
                        const count = brandsMap[brand].length;
                        listContainer.innerHTML += `
                            <div data-brand="${brand}" onclick="openBrandDetails('${brand}')" class="brand-card bg-white border border-slate-200 rounded-[1.2rem] p-4 flex flex-col items-center justify-center gap-2 tap-effect shadow-sm hover:border-emerald-200 transition-colors">
                                <div class="w-10 h-10 bg-emerald-50 text-emerald-500 rounded-full flex items-center justify-center"><i data-lucide="smartphone" class="w-5 h-5"></i></div>
                                <h4 class="text-[12px] font-black text-slate-900 text-center uppercase leading-tight mt-1">${brand}</h4>
                                <span class="text-[9px] font-bold text-slate-400 bg-slate-50 border border-slate-100 px-2.5 py-0.5 rounded-full">${count} Model Disimpan</span>
                            </div>`;
                    }
                    lucide.createIcons(); filterMatrix(); 
                }, error => { listContainer.innerHTML = `<div class="col-span-2 p-5 text-center text-rose-500 text-[10px] font-bold tracking-widest uppercase">Gagal memuat matriks</div>`; });
            } catch (err) { console.error(err); }
        }

        function filterMatrix() {
            const input = document.getElementById('searchBrand').value.toUpperCase();
            document.querySelectorAll('.brand-card').forEach(card => {
                const brand = card.getAttribute('data-brand').toUpperCase();
                card.style.display = brand.includes(input) ? 'flex' : 'none';
            });
        }

        function openBrandDetails(brand) {
            document.getElementById('brandDetailsTitle').innerText = brand;
            const container = document.getElementById('brandDetailsList'); 
            container.innerHTML = '';
            
            globalMatrixData.filter(m => m.brand.toUpperCase() === brand).forEach(m => {
                container.innerHTML += `
                    <div class="bg-slate-50 border border-slate-100 rounded-[1rem] p-3 flex justify-between items-center group">
                        <div><h4 class="text-[11px] font-black text-slate-900">${m.model}</h4>
                            <div class="flex gap-2 mt-1"><span class="text-[8px] font-bold text-slate-500 bg-white border border-slate-200 px-1.5 py-0.5 rounded uppercase">${m.grade}</span><span class="text-[8px] font-black text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded font-num">RM${parseFloat(m.price).toFixed(2)}</span></div>
                        </div>
                        <button onclick="deleteMatrix('${m.id}')" class="w-8 h-8 bg-white border border-rose-100 hover:bg-rose-50 text-rose-500 rounded-lg flex items-center justify-center tap-effect transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>`;
            });
            lucide.createIcons(); 
            
            const m = document.getElementById('brandDetailsModal');
            m.classList.remove('hidden');
            requestAnimationFrame(() => m.classList.add('active'));
        }

        function closeBrandDetails() { 
            const m = document.getElementById('brandDetailsModal');
            m.classList.remove('active');
            setTimeout(() => m.classList.add('hidden'), 300);
        }

        async function saveNewMatrix() {
    const brand = document.getElementById('matBrand').value.trim();
    const model = document.getElementById('matModel').value.trim();
    const grade = document.getElementById('matGrade').value.trim();
    const price = document.getElementById('matPrice').value.trim();

    // Guard clause: Pastikan semua field diisi
    if (!brand || !model || !grade || !price) {
        return showToast("Sila isi semua maklumat!", "error");
    }

    const btn = document.getElementById('btnSaveMat');
    const originalHTML = btn.innerHTML;
    
    // UI Loading state
    btn.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Menyimpan...`;
    lucide.createIcons();

    try {
        const user = firebase.auth().currentUser;
        if (!user) throw new Error("User not authenticated");

        // Simpan data
        await db.collection('pricing_matrix').add({
            uid: user.uid, // Tambah UID untuk keselamatan rules
            brand: brand,
            model: model,
            grade: grade,
            price: parseFloat(price),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast("Matriks harga ditambah!");
        closeMatrixModal();
        
        // Refresh list secara automatik
        if(typeof loadPricingMatrix === 'function') loadPricingMatrix();

    } catch (error) {
        console.error("Firebase Error:", error); // Lihat punca ralat di console log
        showToast("Ralat: " + error.message, "error");
    } finally {
        btn.innerHTML = originalHTML;
        lucide.createIcons();
    }
}
        async function deleteMatrix(id) { if(confirm("Padam matriks harga ini?")) { try { await db.collection('settings').doc('pricing_matrix').collection('items').doc(id).delete(); showToast("Matriks dipadam."); closeBrandDetails(); } catch (error) { showToast("Gagal memadam matriks.", "error"); } } }
    </script>
</body>
</html>
